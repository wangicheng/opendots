<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Storage POC</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #f0f0f0;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    h1 {
      border-bottom: 2px solid #eee;
      padding-bottom: 0.5rem;
    }

    .user-card {
      border: 1px solid #ddd;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 4px;
    }

    .user-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.5rem;
    }

    .avatar {
      width: 50px;
      height: 50px;
      background: #ddd;
      border-radius: 50%;
      object-fit: cover;
    }

    .level-list {
      list-style: none;
      padding: 0;
    }

    .level-item {
      background: #f9f9f9;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 4px;
      border: 1px solid #eee;
    }

    code {
      background: #eee;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Global Data Registry</h1>
    <div id="status">Loading...</div>
    <div id="content"></div>
  </div>

  <script>
    const DB_URL = 'https://raw.githubusercontent.com/wangicheng/opendots/database/data.json';

    async function init() {
      try {
        // Add timestamp to bypass cache for testing
        const res = await fetch(`${DB_URL}?t=${Date.now()}`);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const data = await res.json();
        render(data);
      } catch (err) {
        document.getElementById('status').textContent = 'Error: ' + err.message;
        console.error(err);
      }
    }

    function render(db) {
      const container = document.getElementById('content');
      document.getElementById('status').textContent = 'Data loaded successfully.';

      if (!db.users || Object.keys(db.users).length === 0) {
        container.innerHTML = '<p>No users found in database.</p>';
        return;
      }

      const fragment = document.createDocumentFragment();

      Object.entries(db.users).forEach(([username, user]) => {
        const card = document.createElement('div');
        card.className = 'user-card';

        const avatarUrl = user.avatar || 'https://via.placeholder.com/50';

        const levelsHtml = user.levels && user.levels.length > 0
          ? user.levels.map(l => `
                        <div class="level-item">
                            <strong>${l.id}</strong> <br/>
                            <small>Updated: ${new Date(l.updatedAt).toLocaleString()}</small>
                        </div>
                    `).join('')
          : '<div>No levels published</div>';

        card.innerHTML = `
                    <div class="user-header">
                        <img src="${avatarUrl}" class="avatar" alt="${username}">
                        <h2>${username}</h2>
                    </div>
                    <h3>Levels (${user.levels ? user.levels.length : 0})</h3>
                    <div class="level-list">
                        ${levelsHtml}
                    </div>
                `;
        fragment.appendChild(card);
      });

      container.appendChild(fragment);
    }

    init();
  </script>
</body>

</html>