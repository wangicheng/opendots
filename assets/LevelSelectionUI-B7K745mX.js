import{C as m,G as x,g as U,a as z,U as A,s as e,L as M,T as F,b as Z,c as P,d as mt,O as bt,F as At,N as It,I as St,e as Ft,S as yt,f as xt,B as Tt,h as ut,P as Bt,D as Pt,i as Lt}from"./Game-APSsnEV0.js";import{LanguageManager as T}from"./LanguageManager-DUOSZjRM.js";import"./index-Bu-h5rNC.js";const ft=16,D=256,Ut=10240;class Ht extends m{onClose;currentView="list";overlay;card;fileInputElement=null;constructor(t){super(),this.onClose=t,this.overlay=new x,this.card=new m,this.addChild(this.overlay),this.addChild(this.card),this.refreshUI(),window.addEventListener("resize",this.handleResize),T.getInstance().subscribe(this.handleLanguageChange)}handleLanguageChange=()=>{this.refreshUI()};handleResize=()=>{this.refreshUI()};refreshUI(){const t=U(),n=z();this.overlay.clear(),this.overlay.rect(0,0,t,n),this.overlay.fill({color:0,alpha:.5}),this.overlay.eventMode="static",this.overlay.cursor="default",this.overlay.off("pointertap",this.onClose),this.overlay.on("pointertap",this.onClose),this.card.removeChildren();const s=e(600),i=e(500),a=(t-s)/2,o=(n-i)/2;this.card=A.createCard(s,i,16777215,0),this.card.position.set(a,o),this.addChild(this.card),this.card.eventMode="static",this.card.on("pointertap",r=>r.stopPropagation()),this.currentView==="list"?this.drawListView(s):this.currentView==="profile"?this.drawProfileView(s):this.currentView==="language"&&this.drawLanguageView(s)}drawListView(t){const n=h=>T.getInstance().t(h),s={title:n("settings.title"),showBack:!1};this.drawHeader(t,s);const i=e(100),a=e(60),o=t-e(40),r=e(20);[{label:n("settings.profile"),onClick:()=>this.setView("profile"),icon:""},{label:n("settings.language"),onClick:()=>this.setView("language"),icon:""},{label:n("settings.github"),onClick:()=>{window.open("https://github.com/wangicheng/opendots","_blank")},icon:""}].forEach((h,c)=>{const f=i+c*(a+e(10)),C=this.createListItem(h.label,h.icon,o,a,h.onClick);C.container.position.set(r,f),this.card.addChild(C.container)})}drawProfileView(t){const n=S=>T.getInstance().t(S);this.drawHeader(t,{title:n("profile.title"),showBack:!0,onBack:()=>this.setView("list")});const s=M.getInstance().getUserProfile(),i=t/2,a=e(120),o=e(50),r=A.createAvatar(o,s.avatarUrl,s.avatarColor,14737632);r.position.set(i,a),this.card.addChild(r),r.eventMode="static",r.cursor="pointer",r.on("pointertap",()=>{this.triggerFileUpload()});const l=new F({text:n("profile.upload"),style:{fontFamily:"Arial",fontSize:e(12),fill:"#AAAAAA"}});l.anchor.set(.5),l.position.set(i,a+o+e(15)),this.card.addChild(l);const h=a+o+e(60),c=new F({text:n("profile.name"),style:{fontFamily:"Arial",fontSize:e(14),fill:"#888888",fontWeight:"bold"}});c.position.set(e(40),h),this.card.addChild(c);const f=t-e(80),C=e(40),u=e(40),p=h+e(25),d=A.createPill(f,C,16119285,14540253,1);d.position.set(u,p),d.eventMode="static",d.cursor="text",d.on("pointertap",()=>{let S=window.prompt(n("profile.prompt"),s.name);if(S!==null){let b=S.trim();b.length>0&&(b.length>ft&&(b=b.substring(0,ft)),M.getInstance().updateUserProfile({name:b}),this.refreshUI(),this.emit("profileUpdate"))}}),this.card.addChild(d);const g=new F({text:s.name,style:{fontFamily:"Arial",fontSize:e(18),fill:"#333333"}});g.anchor.set(0,.5),g.position.set(u+e(10),p+C/2),g.eventMode="none",this.card.addChild(g);const v=A.createIcon("",e(16),"#AAAAAA");v.anchor.set(1,.5),v.position.set(u+f-e(10),p+C/2+e(2)),v.eventMode="none",this.card.addChild(v);const w=p+C+e(40),I=A.createButton("Cloud Save",t-e(80),e(40),16031813,"#FFFFFF",()=>{const b="https://github.com/wangicheng/opendots/issues/new",y={};s.name&&(y.name=s.name),s.avatarUrl&&(y.avatar=s.avatarUrl);const B=JSON.stringify(y);if(B.length>5e3&&!window.confirm(n("profile.warn_large_payload")||"Data is large. Proceed to GitHub?"))return;const H=new URLSearchParams({template:"update_profile.yml",title:"[Data]: Update Profile",labels:"data-submission",payload:B});window.open(`${b}?${H.toString()}`,"_blank")});I.position.set(t/2,w),this.card.addChild(I)}drawLanguageView(t){const n=c=>T.getInstance().t(c);this.drawHeader(t,{title:n("language.title"),showBack:!0,onBack:()=>this.setView("list")});const i=T.getInstance().getAvailableLanguages().map(c=>({code:c,label:n(`language.${c}`)})),a=e(100),o=e(60),r=t-e(40),l=e(20),h=T.getInstance().getCurrentLanguage();i.forEach((c,f)=>{const C=a+f*(o+e(10)),u=c.code===h,p=u?"":"",d=this.createListItem(c.label,p,r,o,()=>{T.getInstance().setLanguage(c.code)});if(d.container.position.set(l,C),u){d.bg.clear();const g=o/2;d.bg.roundRect(0,0,r,o,g),d.bg.stroke({width:2,color:3646697}),d.bg.fill(15792383),d.icon.style.fill="#37A4E9"}d.chevron.visible=!1,this.card.addChild(d.container)})}drawHeader(t,n){const s=e(60),i=new F({text:n.title,style:{fontFamily:"Arial",fontSize:e(24),fill:"#333333",fontWeight:"bold"}});if(i.anchor.set(.5),i.position.set(t/2,s/2),this.card.addChild(i),n.showBack&&n.onBack){const o=new m,r=new x;r.rect(0,0,e(40),e(40)),r.fill({color:16777215,alpha:.001}),o.addChild(r);const l=A.createIcon("",e(24),"#555555");l.anchor.set(.5),l.position.set(e(20),e(20)+e(2)),o.addChild(l),o.position.set(e(10),(s-e(40))/2),o.eventMode="static",o.cursor="pointer",o.on("pointertap",n.onBack),this.card.addChild(o)}else if(!n.showBack){const o=new m,r=new x;r.rect(0,0,e(40),e(40)),r.fill({color:16777215,alpha:.001}),o.addChild(r);const l=new F({text:"×",style:{fontFamily:"Arial",fontSize:e(32),fill:"#AAAAAA"}});l.anchor.set(.5),l.position.set(e(20),e(20)+e(2)),o.addChild(l),o.position.set(t-e(50),(s-e(40))/2),o.eventMode="static",o.cursor="pointer",o.on("pointertap",this.onClose),this.card.addChild(o)}const a=new x;a.rect(0,s,t,1),a.fill(15658734),this.card.addChild(a)}createListItem(t,n,s,i,a){const o=new m,r=A.createPill(s,i,16382457);o.addChild(r);const l=A.createIcon(n,e(20),"#555555");l.anchor.set(.5),l.position.set(e(30),i/2+e(2)),o.addChild(l);const h=new F({text:t,style:{fontFamily:"Arial",fontSize:e(18),fill:"#333333"}});h.anchor.set(0,.5),h.position.set(e(60),i/2),o.addChild(h);const c=A.createIcon("",e(16),"#CCCCCC");return c.anchor.set(.5),c.position.set(s-e(20),i/2+e(2)),o.addChild(c),o.eventMode="static",o.cursor="pointer",o.on("pointertap",a),{container:o,bg:r,icon:l,label:h,chevron:c}}setView(t){this.currentView=t,this.refreshUI()}triggerFileUpload(){this.fileInputElement&&this.removeFileInput();const t=document.createElement("input");t.type="file",t.accept="image/*",t.style.display="none",document.body.appendChild(t),t.addEventListener("change",n=>{const s=n.target.files?.[0];if(s){const i=new FileReader;i.onload=a=>{const o=a.target?.result;if(o){const r=new Image;r.onerror=()=>{console.error("Failed to load uploaded image")},r.onload=()=>{let l=r.width,h=r.height;(l>D||h>D)&&(l>h?(h=Math.round(h*(D/l)),l=D):(l=Math.round(l*(D/h)),h=D));const c=document.createElement("canvas");c.width=l,c.height=h;const f=c.getContext("2d");if(f){f.drawImage(r,0,0,l,h);let C=0,u=1,p=c.toDataURL("image/jpeg",.1);for(let d=0;d<3;d++){const g=(C+u)/2,v=c.toDataURL("image/jpeg",g);(v.split(",")[1]||"").length*.75<=Ut?(p=v,C=g):u=g}M.getInstance().updateUserProfile({avatarUrl:p}),this.refreshUI(),this.emit("profileUpdate")}},r.src=o}},i.readAsDataURL(s)}this.removeFileInput()}),t.click(),this.fileInputElement=t}removeFileInput(){this.fileInputElement&&(this.fileInputElement.parentNode&&this.fileInputElement.parentNode.removeChild(this.fileInputElement),this.fileInputElement=null)}destroy(t){window.removeEventListener("resize",this.handleResize),T.getInstance().unsubscribe(this.handleLanguageChange),this.removeFileInput(),super.destroy(t)}}class kt extends m{onCloseCallback;onViewLevelsCallback;onDeleteCallback;allowDelete;levelData;userColor;getThumbnail;constructor(t,n,s,i,a,o,r=!1){super(),this.levelData=t,this.userColor=n,this.getThumbnail=s,this.onCloseCallback=i,this.onViewLevelsCallback=a,this.onDeleteCallback=o,this.allowDelete=r,this.refreshUI(),window.addEventListener("resize",this.handleResize)}handleResize=()=>{this.refreshUI()};refreshUI(){this.removeChildren();const t=U(),n=z();this.zIndex=2e3;const s=A.createOverlay(t,n,.5);s.eventMode="static",s.cursor="pointer",s.on("pointertap",()=>this.onCloseCallback()),this.addChild(s);const i=e(800),a=e(40),o=e(20),r=i-a*2-o,l=r*.6,h=r*.4,c=l,f=c*(9/16),C=e(80),u=f+C+a*2,p=A.createCard(i,u,16777215);p.position.set((t-i)/2,(n-u)/2),this.addChild(p),p.eventMode="static",p.on("pointertap",E=>E.stopPropagation());const d=new m;d.position.set(a,a),p.addChild(d);const g=new m,v=A.createShadow(c,f,0,8,.3);g.addChild(v);const w=new x;w.rect(0,0,c,f),w.fill(16119285),w.stroke({width:1,color:15658734}),g.addChild(w);const I=new x;I.rect(0,0,c,f),I.fill(16777215),g.addChild(I);const S=this.getThumbnail(c,f);S.mask=I,g.addChild(S),d.addChild(g);const b=new m;b.position.set(0,f+e(15)),d.addChild(b);const y=new m;b.addChild(y);const B=E=>T.getInstance().t(E),H=new Z({fontFamily:"Arial",fontSize:e(14),fill:"#888888"}),k=new Z({fontFamily:"Arial",fontSize:e(14),fontWeight:"bold",fill:"#555555"}),R=(E,wt,vt)=>{const q=new m,ct=new F({text:E,style:H}),dt=new F({text:wt,style:k});return dt.x=ct.width+e(5),q.addChild(ct,dt),q.y=vt,q},L=this.levelData.isPublished?new Date(this.levelData.createdAt||Date.now()).toLocaleDateString():this.levelData.createdAt?new Date(this.levelData.createdAt).toLocaleDateString():"-",W=this.levelData.isPublished?B("level.published"):B("level.created");y.addChild(R(W,L,0));const $=this.levelData.attempts??0;y.addChild(R(B("level.attempts"),$.toString(),e(25)));const et=this.levelData.clears??0,gt=$>0?Math.round(et/$*100):0;y.addChild(R(B("level.clears"),`${et} (${gt}%)`,e(50)));const it=e(100),st=e(36),nt=this.createLikeButton(0,it,st);nt.position.set(c-it,(e(75)-st)/2),b.addChild(nt);const V=new m;V.position.set(a+l+o,a),p.addChild(V);const ot=f+C,X=h,pt=A.createCard(X,ot,16777215);V.addChild(pt);const N=X/2,j=e(70);let O=e(30),at=this.userColor,rt;if(this.levelData.authorId===P){const E=M.getInstance().getUserProfile();at=E.avatarColor,rt=E.avatarUrl}const lt=A.createAvatar(j,rt,at);lt.position.set(N,O+j),V.addChild(lt),O+=j*2+e(15);const Ct=this.levelData.author||"Unknown",Y=new F({text:Ct,style:{fontFamily:"Arial",fontSize:e(20),fontWeight:"bold",fill:"#555555",align:"center",wordWrap:!0,wordWrapWidth:X-e(20)}});Y.anchor.set(.5,0),Y.position.set(N,O),V.addChild(Y),O+=Y.height+e(5);const K=new F({text:B("profile.total_levels")+"42",style:{fontFamily:"Arial",fontSize:e(14),fill:"#AAAAAA",align:"center"}});K.anchor.set(.5,0),K.position.set(N,O),V.addChild(K);const ht=this.levelData.authorId===P&&this.allowDelete?this.createDeleteButton(X-e(40)):this.createViewLevelsButton(X-e(40));ht.position.set(N,ot-e(30)),V.addChild(ht);const _=new m,G=e(40),Q=new x;Q.rect(0,0,G,G),Q.fill({color:16777215,alpha:.001}),_.addChild(Q);const J=new F({text:"×",style:{fontFamily:"Arial",fontSize:e(32),fill:"#AAAAAA"}});J.anchor.set(.5),J.position.set(G/2,G/2),_.addChild(J),_.position.set(i-G-e(5),e(5)),_.eventMode="static",_.cursor="pointer",_.on("pointertap",()=>this.onCloseCallback()),p.addChild(_)}createLikeButton(t,n,s){const i=new m,a=n,o=s||e(36),r=o/2,l=A.createPill(a,o,16777215,16739179,2);i.addChild(l);const h=A.createIcon("",e(20),"#FF6B6B");i.addChild(h);let c=t;const f=new F({text:c.toString(),style:{fontFamily:"Arial",fontSize:e(24),fill:"#FF6B6B",fontWeight:"bold"}});f.anchor.set(0,.5),i.addChild(f);const C=()=>{const g=e(12),v=h.width+g+f.width,w=(a-v)/2;h.position.set(w+h.width/2,o/2+e(2)),f.position.set(w+h.width+g,o/2)};C(),i.eventMode="static",i.cursor="pointer";let u=!!this.levelData.isLikedByCurrentUser;const p=u?t-1:t;return(()=>{const g=p+(u?1:0);f.text=g.toString(),C(),u?(l.clear(),l.roundRect(0,0,a,o,r),l.fill({color:16739179}),h.style.fill="#FFFFFF",f.style.fill="#FFFFFF"):(l.clear(),l.roundRect(0,0,a,o,r),l.stroke({width:2,color:16739179}),l.fill({color:16777215}),h.style.fill="#FF6B6B",f.style.fill="#FF6B6B")})(),i}createViewLevelsButton(t){const n=t,s=e(36),i=A.createButton(T.getInstance().t("profile.view_levels"),n,s,3646697,"#FFFFFF",()=>{this.levelData.authorId&&this.onViewLevelsCallback(this.levelData.authorId)},14);return i.pivot.set(n/2,s/2),i}createDeleteButton(t){const n=t,s=e(36),i=new m,a=A.createPill(n,s,16777215,16739179,1);a.position.set(-n/2,-s/2),i.addChild(a);const o=new F({text:T.getInstance().t("level.delete"),style:{fontFamily:"Arial",fontSize:e(14),fill:"#FF6B6B",fontWeight:"bold"}});return o.anchor.set(.5),i.addChild(o),i.eventMode="static",i.cursor="pointer",i.on("pointertap",()=>{if(this.onDeleteCallback){const r=new mt(T.getInstance().t("level.delete_confirm"),()=>{this.onDeleteCallback&&this.onDeleteCallback(this.levelData.id),this.removeChild(r),r.destroy()},()=>{this.removeChild(r),r.destroy()},{confirmKey:"level.delete",cancelKey:"common.cancel"});this.addChild(r)}}),i}destroy(t){window.removeEventListener("resize",this.handleResize),super.destroy(t)}}class Wt extends m{levels;onSelect;onCreate;currentPage=0;totalPages=0;laserTexture;gridContainer;headerContainer;isDragging=!1;dragStartX=0;dragStartPageX=0;dragDistance=0;scrollTweenId=0;penSelectionUI=null;settingsUI=null;userProfileCard=null;onPenSelect;currentPenId="pen_default";sortMode="latest";filterAuthorId=null;visibleLevels=[];filterAuthorName=null;filterAuthorColor=8947848;latestBtnText;popularBtnText;mineBtnText;filterFilterTagContainer;createLevelBtn;HEADER_HEIGHT_RATIO=1/5;COLS=3;ROWS=2;ITEMS_PER_PAGE=6;CARD_ASPECT_RATIO=16/9;backgroundHitArea=null;constructor(t,n,s,i,a,o){super(),this.levels=t,this.onSelect=n,this.onCreate=s,this.laserTexture=i,this.onPenSelect=a,o&&(this.currentPenId=o),this.totalPages=Math.ceil(t.length/this.ITEMS_PER_PAGE),this.headerContainer=new m,this.gridContainer=new m,this.addChild(this.gridContainer),this.addChild(this.headerContainer),this.setupHeader(),this.refreshVisibleLevels(),this.setupInteraction(),T.getInstance().subscribe(()=>{this.headerContainer.removeChildren(),this.setupHeader(),this.setupGrid()})}setupHeader(){const t=v=>T.getInstance().t(v),n=U(),s=this.getHeaderHeight(),i=new Z({fontFamily:"Arial",fontSize:e(60),fontWeight:"bold",fill:"#555555"}),a=new F({text:t("app.title"),style:i});a.position.set(e(60),(s-a.height)/2),this.headerContainer.addChild(a);const o=(s+e(10))/2;this.latestBtnText=this.createSortButton(t("sort.latest"),0,o,"latest"),this.headerContainer.addChild(this.latestBtnText),this.popularBtnText=this.createSortButton(t("sort.popular"),0,o,"popular"),this.headerContainer.addChild(this.popularBtnText),this.mineBtnText=this.createHeaderInteractiveText(t("sort.mine"),0,o,()=>{this.filterAuthorId===P?this.setFilterAuthor(null):this.setFilterAuthor(P)}),this.headerContainer.addChild(this.mineBtnText);const r=e(40),l=this.latestBtnText.width+r+this.popularBtnText.width+r+this.mineBtnText.width,h=(n-l)/2;this.latestBtnText.x=h,this.popularBtnText.x=h+this.latestBtnText.width+r,this.mineBtnText.x=h+this.latestBtnText.width+r+this.popularBtnText.width+r,this.filterFilterTagContainer=new m,this.filterFilterTagContainer=new m,this.headerContainer.addChild(this.filterFilterTagContainer),this.updateFilterTag();const c=e(36),f=e(52),C=e(20),u=this.createHeaderButton(""),p=n-e(20)-f;u.position.set(p,c),u.on("pointertap",()=>this.showSettings()),this.headerContainer.addChild(u);const d=this.createHeaderButton(""),g=p-C-f;d.position.set(g,c),d.on("pointertap",()=>this.showPenSelection()),this.headerContainer.addChild(d),this.createLevelBtn=this.createFloatingActionButton(),this.createLevelBtn.visible=!1,this.addChild(this.createLevelBtn),this.updateSortButtons()}getHeaderHeight(){return z()*this.HEADER_HEIGHT_RATIO}createFloatingActionButton(){const t=e(64),n=new m,s=new x;s.circle(0,0,t/2),s.fill(5592405),n.addChild(s);const i=new F({text:"+",style:{fontFamily:"Arial",fontSize:e(40),fill:"#FFFFFF",fontWeight:"bold"}});return i.anchor.set(.5),i.position.set(0,0),n.addChild(i),n.position.set(U()-e(50),z()-e(50)),n.eventMode="static",n.cursor="pointer",n.on("pointertap",()=>{console.log("Create Level Attempt"),this.onCreate()}),n}createSortButton(t,n,s,i){return this.createHeaderInteractiveText(t,n,s,()=>{this.setSortMode(i)})}createHeaderInteractiveText(t,n,s,i){const a=new F({text:t,style:{fontFamily:"Arial",fontSize:e(24),fill:"#AAAAAA",fontWeight:"normal"}});return a.anchor.set(0,.5),a.position.set(n,s),a.eventMode="static",a.cursor="pointer",a.on("pointertap",i),a}updateSortButtons(){const t=this.filterAuthorId===P;if(this.latestBtnText){const n=this.sortMode==="latest"&&!t;this.latestBtnText.style.fill=n?"#555555":"#AAAAAA",this.latestBtnText.style.fontWeight=n?"bold":"normal"}if(this.popularBtnText){const n=this.sortMode==="popular"&&!t;this.popularBtnText.style.fill=n?"#555555":"#AAAAAA",this.popularBtnText.style.fontWeight=n?"bold":"normal"}if(this.mineBtnText){const n=t;this.mineBtnText.style.fill=n?"#555555":"#AAAAAA",this.mineBtnText.style.fontWeight=n?"bold":"normal"}this.createLevelBtn&&(this.createLevelBtn.visible=t)}createHeaderButton(t){const n=e(52),s=new m,i=new x;i.rect(0,0,n,n),i.fill({color:16777215,alpha:.001}),s.addChild(i);const a=A.createIcon(t,e(60),"#555555");return a.style.stroke={color:"#555555",width:.5},a.position.set(n/2,n/2+e(2)),s.addChild(a),s.eventMode="static",s.cursor="pointer",s}setupGrid(){this.gridContainer.removeChildren();const t=U();for(let n=0;n<this.totalPages;n++){const s=new m;s.x=n*t,this.gridContainer.addChild(s);const i=n*this.ITEMS_PER_PAGE,a=Math.min(i+this.ITEMS_PER_PAGE,this.visibleLevels.length);this.renderPage(s,i,a)}}renderPage(t,n,s){const i=U(),a=z(),o=this.getHeaderHeight(),r=i,l=a-o,h=r*.7/this.COLS,c=Math.floor(h),f=Math.floor(c/this.CARD_ASPECT_RATIO),C=(r-c*this.COLS)/(this.COLS+1),u=(l-f*this.ROWS)/(this.ROWS+1),p=o+u;for(let d=n;d<s;d++){const g=d-n,v=Math.floor(g/this.COLS),w=g%this.COLS,I=C+w*(c+C),S=p+v*(f+u),b=this.createLevelCard(d,this.visibleLevels[d],c,f);b.position.set(I,S),t.addChild(b)}}createLevelCard(t,n,s,i){const a=new m,o=A.createShadow(s,i,0,8,.3);a.addChild(o);const r=A.createCardBackground(s,i,16777215);a.addChild(r);const l=this.createLevelThumbnail(n,s,i),h=new x;if(h.rect(0,0,s,i),h.fill(16777215),l.mask=h,a.addChild(h),a.addChild(l),n.authorId===P&&n.isPublished===!1){const w=new x;w.rect(0,0,s,i),w.fill({color:0,alpha:.2}),a.addChild(w);const I=new m,S=new x;let b="",y=0,B="#FFFFFF";n.authorPassed?(b=T.getInstance().t("status.draft"),y=8947848,B="#FFFFFF"):(b=T.getInstance().t("status.untested"),y=15658734,B="#888888");const H=e(24),k=e(12),R=e(20),L=new F({text:b,style:{fontFamily:"Arial",fontSize:e(12),fill:B,fontWeight:"bold"}}),W=Math.max(e(60),L.width+R);S.roundRect(0,0,W,H,k),S.fill(y),L.anchor.set(.5),L.position.set(W/2,H/2),I.addChild(S),I.addChild(L),I.position.set(e(10),e(10)),a.addChild(I)}else{const I=new m,S=new F({text:"0",style:{fontFamily:"Arial",fontSize:e(12),fill:"#FFFFFF",fontWeight:"bold"}}),b=e(10),y=e(14),B=e(4),H=b+y+B+S.width+b,k=e(24),R=e(12),L=new x;L.roundRect(0,0,H,k,R),L.fill({color:0,alpha:.4}),I.addChild(L);const W=A.createIcon("",y,"#FFFFFF");W.position.set(b+y/2,k/2+e(2)),I.addChild(W),S.anchor.set(0,.5),S.position.set(b+y+B,k/2),I.addChild(S),I.position.set(e(12),e(12)),a.addChild(I)}const c=e(25),f=[16739179,5164484,4569041,16760438,16742777,12246104],C=n.authorId||n.author||"unknown";let u=0;for(let w=0;w<C.length;w++)u=C.charCodeAt(w)+((u<<5)-u);const p=Math.abs(u)%f.length;let d=f[p],g;if(n.authorId===P){const w=M.getInstance().getUserProfile();d=w.avatarColor,g=w.avatarUrl}const v=A.createAvatar(c,g,d,16777215);return v.position.set(s-e(4),i-e(4)),v.eventMode="static",v.cursor="pointer",v.on("pointertap",w=>{w.stopPropagation(),this.showUserProfile(n,d)}),a.addChild(v),a.addChild(v),a.eventMode="static",a.cursor="pointer",a.on("pointertap",()=>{this.dragDistance<10&&this.onSelect(n)}),a}createLevelThumbnail(t,n,s){const i=new m,a=Math.min(n/Pt,s/Lt);if(i.scale.set(a),t.obstacles&&t.obstacles.forEach(o=>i.addChild(bt.createVisual(o))),t.fallingObjects&&t.fallingObjects.forEach(o=>i.addChild(At.createVisual(o))),t.nets&&t.nets.forEach(o=>i.addChild(It.createVisual(o))),t.iceBlocks&&t.iceBlocks.forEach(o=>i.addChild(St.createVisual(o))),t.lasers&&this.laserTexture&&t.lasers.forEach(o=>i.addChild(Ft.createVisual(o,this.laserTexture,14))),t.seesaws&&t.seesaws.forEach(o=>i.addChild(yt.createVisual(o))),t.conveyors&&t.conveyors.forEach(o=>i.addChild(xt.createVisual(o))),t.buttons&&t.buttons.forEach(o=>i.addChild(Tt.createVisual(o))),t.balls){const o=ut.createVisual(t.balls.blue.x,t.balls.blue.y,"blue"),r=ut.createVisual(t.balls.pink.x,t.balls.pink.y,"pink");i.addChild(o),i.addChild(r)}return i}setupInteraction(){const t=U(),n=z(),s=this.getHeaderHeight();this.backgroundHitArea=new x,this.backgroundHitArea.rect(0,s,t,n-s),this.backgroundHitArea.fill({color:0,alpha:0}),this.addChildAt(this.backgroundHitArea,0),this.eventMode="static",this.on("pointerdown",i=>{if(this.penSelectionUI||this.userProfileCard||this.settingsUI)return;const a=this.getHeaderHeight();this.toLocal(i.global).y<a||(this.isDragging=!0,this.dragStartX=i.global.x,this.dragDistance=0,this.dragStartPageX=this.gridContainer.x)}),this.on("pointermove",i=>{if(!this.isDragging)return;const o=i.global.x-this.dragStartX;this.dragDistance=Math.max(this.dragDistance,Math.abs(o)),this.gridContainer.x=this.dragStartPageX+o}),this.on("pointerup",i=>this.endDrag(i)),this.on("pointerupoutside",i=>this.endDrag(i))}endDrag(t){if(!this.isDragging)return;this.isDragging=!1;const s=t.global.x-this.dragStartX;Math.abs(s)>50&&(s>0&&this.currentPage>0?this.currentPage--:s<0&&this.currentPage<this.totalPages-1&&this.currentPage++),this.scrollToPage(this.currentPage)}scrollToPage(t){const n=U(),s=-t*n,i=this.gridContainer.x,a=s-i,o=.3,r=Date.now(),l=++this.scrollTweenId,h=()=>{if(this.scrollTweenId!==l)return;const c=Date.now(),f=Math.min((c-r)/(o*1e3),1),C=1-Math.pow(1-f,3);this.gridContainer.x=i+a*C,f<1&&requestAnimationFrame(h)};h()}showPenSelection(){this.penSelectionUI&&(this.removeChild(this.penSelectionUI),this.penSelectionUI.destroy(),this.penSelectionUI=null),this.penSelectionUI=new Bt(t=>{this.onPenSelect&&this.onPenSelect(t),this.currentPenId=t.id,this.closePenSelection()},()=>this.closePenSelection(),this.currentPenId),this.penSelectionUI.zIndex=1e3,this.addChild(this.penSelectionUI)}closePenSelection(){this.penSelectionUI&&(this.removeChild(this.penSelectionUI),this.penSelectionUI.destroy(),this.penSelectionUI=null)}showSettings(){this.settingsUI&&(this.removeChild(this.settingsUI),this.settingsUI.destroy(),this.settingsUI=null),this.settingsUI=new Ht(()=>this.closeSettings()),this.settingsUI.zIndex=2e3,this.settingsUI.on("profileUpdate",()=>{M.getInstance().getLevelList().then(t=>{this.levels=t,this.refreshVisibleLevels()})}),this.addChild(this.settingsUI)}closeSettings(){this.settingsUI&&(this.removeChild(this.settingsUI),this.settingsUI.destroy(),this.settingsUI=null,M.getInstance().getLevelList().then(t=>{this.levels=t,this.refreshVisibleLevels()}))}showUserProfile(t,n){this.userProfileCard&&(this.removeChild(this.userProfileCard),this.userProfileCard.destroy(),this.userProfileCard=null),this.userProfileCard=new kt(t,n,(s,i)=>this.createLevelThumbnail(t,s,i),()=>this.closeUserProfile(),s=>{this.closeUserProfile(),this.setFilterAuthor(s,t.author||"",n)},s=>{if(t.isPublished){const i=t.originalId||s,o=JSON.stringify({id:i}),l="https://github.com/wangicheng/opendots/issues/new",h=new URLSearchParams({template:"delete_level.yml",title:`[Data]: Delete Level ${i}`,labels:"data-submission",payload:o});window.open(`${l}?${h.toString()}`,"_blank")}M.getInstance().deleteLevel(s),this.closeUserProfile(),this.levels=this.levels.filter(i=>i.id!==s),this.refreshVisibleLevels()},this.filterAuthorId===P),this.addChild(this.userProfileCard)}closeUserProfile(){this.userProfileCard&&(this.removeChild(this.userProfileCard),this.userProfileCard.destroy(),this.userProfileCard=null)}setPen(t){this.currentPenId=t}setSortMode(t){if(this.filterAuthorId===P&&this.setFilterAuthor(null),this.sortMode===t&&this.filterAuthorId===null){this.currentPage!==0&&(this.currentPage=0,this.scrollToPage(0));return}this.sortMode=t,this.updateSortButtons(),this.refreshVisibleLevels()}setFilterAuthor(t,n,s){this.filterAuthorId!==t&&(this.filterAuthorId=t,t?(this.filterAuthorName=n||`User ${t.slice(0,4)}`,this.filterAuthorColor=s||8947848,t===P&&(this.sortMode="latest")):this.filterAuthorName=null,this.updateSortButtons(),this.updateFilterTag(),this.refreshVisibleLevels())}updateFilterTag(){if(!this.filterFilterTagContainer)return;if(this.filterFilterTagContainer.removeChildren(),!this.filterAuthorId||this.filterAuthorId===P){this.filterFilterTagContainer.visible=!1;return}this.filterFilterTagContainer.visible=!0;const t=e(40),n=e(6),s=e(12),i=e(8),a=e(28),o=e(16),r=e(14),l=16777215,h=14737632,c=3355443,f=10066329,C=16119285,u=new x,p=new x;p.circle(0,0,a/2),p.fill(this.filterAuthorColor),p.position.set(n+a/2,t/2);const d=new F({text:this.filterAuthorName||"Unknown",style:{fontFamily:"Arial",fontSize:o,fill:c,fontWeight:"bold"}});d.anchor.set(0,.5),d.position.set(n+a+i,t/2);const g=new F({text:"✕",style:{fontFamily:"Arial",fontSize:e(14),fill:f,fontWeight:"bold"}});g.anchor.set(.5);const v=n+a+i+d.width+i+r+s;u.roundRect(0,0,v,t,t/2),u.fill(l),u.stroke({width:1,color:h}),g.position.set(v-s-r/2,t/2),this.filterFilterTagContainer.addChild(u),this.filterFilterTagContainer.addChild(p),this.filterFilterTagContainer.addChild(d),this.filterFilterTagContainer.addChild(g);const w=U(),S=(z()*this.HEADER_HEIGHT_RATIO+e(10))/2;if(this.mineBtnText)this.filterFilterTagContainer.x=this.mineBtnText.x+this.mineBtnText.width+e(30);else{const b=w/2;this.filterFilterTagContainer.x=b+e(200)}this.filterFilterTagContainer.y=S-t/2,this.filterFilterTagContainer.eventMode="static",this.filterFilterTagContainer.cursor="pointer",this.filterFilterTagContainer.on("pointerover",()=>{u.clear(),u.roundRect(0,0,v,t,t/2),u.fill(C),u.stroke({width:1,color:h})}),this.filterFilterTagContainer.on("pointerout",()=>{u.clear(),u.roundRect(0,0,v,t,t/2),u.fill(l),u.stroke({width:1,color:h})}),this.filterFilterTagContainer.on("pointertap",()=>{this.setFilterAuthor(null)})}refreshVisibleLevels(){let t=this.levels;const n=this.filterAuthorId;n===P?t=t.filter(s=>s.authorId===n):n?t=t.filter(s=>s.authorId===n&&s.isPublished!==!1):t=t.filter(s=>s.isPublished!==!1&&s.authorId!==P),t=[...t],this.sortMode==="popular"?t.sort((s,i)=>(i.likes||0)-(s.likes||0)):t.sort((s,i)=>(i.createdAt||0)-(s.createdAt||0)),this.visibleLevels=t,this.scrollTweenId++,this.currentPage=0,this.totalPages=Math.ceil(this.visibleLevels.length/this.ITEMS_PER_PAGE),this.totalPages===0&&(this.totalPages=1),this.gridContainer.x=0,this.setupGrid()}updateLayout(){this.headerContainer.removeChildren(),this.createLevelBtn&&(this.removeChild(this.createLevelBtn),this.createLevelBtn.destroy({children:!0}),this.createLevelBtn=void 0),this.backgroundHitArea&&(this.removeChild(this.backgroundHitArea),this.backgroundHitArea.destroy(),this.backgroundHitArea=null),this.setupHeader(),this.setupGrid(),this.setupInteraction(),this.currentPage>=this.totalPages&&(this.currentPage=Math.max(0,this.totalPages-1)),this.gridContainer.x=-this.currentPage*U(),this.penSelectionUI,this.userProfileCard}updateLevels(t){this.levels=t,this.refreshVisibleLevels()}}export{Wt as LevelSelectionUI};
