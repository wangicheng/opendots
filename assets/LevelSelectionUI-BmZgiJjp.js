import{C as A,G as S,g as k,a as z,U as b,s as e,M as U,T as m,b as J,c as P,d as At,O as It,F as bt,N as mt,I as Ft,L as St,S as xt,e as Tt,B as yt,f as gt,P as Bt,D as Pt,h as Lt}from"./Game-uYUAUSY6.js";import{LanguageManager as x}from"./LanguageManager-DUOSZjRM.js";import"./index-CZt8xaOs.js";const ut=16,D=256,kt=10240;class Ut extends A{onClose;currentView="list";overlay;card;fileInputElement=null;constructor(t){super(),this.onClose=t,this.overlay=new S,this.card=new A,this.addChild(this.overlay),this.addChild(this.card),this.refreshUI(),window.addEventListener("resize",this.handleResize),x.getInstance().subscribe(this.handleLanguageChange)}handleLanguageChange=()=>{this.refreshUI()};handleResize=()=>{this.refreshUI()};refreshUI(){const t=k(),s=z();this.overlay.clear(),this.overlay.rect(0,0,t,s),this.overlay.fill({color:0,alpha:.5}),this.overlay.eventMode="static",this.overlay.cursor="default",this.overlay.off("pointertap",this.onClose),this.overlay.on("pointertap",this.onClose),this.card.removeChildren();const n=e(600),i=e(500),a=(t-n)/2,o=(s-i)/2;this.card=b.createCard(n,i,16777215,0),this.card.position.set(a,o),this.addChild(this.card),this.card.eventMode="static",this.card.on("pointertap",r=>r.stopPropagation()),this.currentView==="list"?this.drawListView(n):this.currentView==="profile"?this.drawProfileView(n):this.currentView==="language"&&this.drawLanguageView(n)}drawListView(t){const s=h=>x.getInstance().t(h),n={title:s("settings.title"),showBack:!1};this.drawHeader(t,n);const i=e(100),a=e(60),o=t-e(40),r=e(20);[{label:s("settings.profile"),onClick:()=>this.setView("profile"),icon:""},{label:s("settings.language"),onClick:()=>this.setView("language"),icon:""},{label:s("settings.github"),onClick:()=>{window.open("https://github.com/wangicheng/opendots","_blank")},icon:""}].forEach((h,c)=>{const u=i+c*(a+e(10)),w=this.createListItem(h.label,h.icon,o,a,h.onClick);w.container.position.set(r,u),this.card.addChild(w.container)})}drawProfileView(t){const s=p=>x.getInstance().t(p);this.drawHeader(t,{title:s("profile.title"),showBack:!0,onBack:()=>this.setView("list")});const n=U.getInstance().getUserProfile(),i=t/2,a=e(120),o=e(50),r=b.createAvatar(o,n.avatarUrl,n.avatarColor,14737632);r.position.set(i,a),this.card.addChild(r),r.eventMode="static",r.cursor="pointer",r.on("pointertap",()=>{this.triggerFileUpload()});const l=new m({text:s("profile.upload"),style:{fontFamily:"Arial",fontSize:e(12),fill:"#AAAAAA"}});l.anchor.set(.5),l.position.set(i,a+o+e(15)),this.card.addChild(l);const h=a+o+e(60),c=new m({text:s("profile.name"),style:{fontFamily:"Arial",fontSize:e(14),fill:"#888888",fontWeight:"bold"}});c.position.set(e(40),h),this.card.addChild(c);const u=t-e(80),w=e(40),d=e(40),C=h+e(25),g=b.createPill(u,w,16119285,14540253,1);g.position.set(d,C),g.eventMode="static",g.cursor="text",g.on("pointertap",()=>{let p=window.prompt(s("profile.prompt"),n.name);if(p!==null){let I=p.trim();I.length>0&&(I.length>ut&&(I=I.substring(0,ut)),U.getInstance().updateUserProfile({name:I}),this.refreshUI(),this.emit("profileUpdate"))}}),this.card.addChild(g);const f=new m({text:n.name,style:{fontFamily:"Arial",fontSize:e(18),fill:"#333333"}});f.anchor.set(0,.5),f.position.set(d+e(10),C+w/2),f.eventMode="none",this.card.addChild(f);const v=b.createIcon("",e(16),"#AAAAAA");v.anchor.set(1,.5),v.position.set(d+u-e(10),C+w/2+e(2)),v.eventMode="none",this.card.addChild(v)}drawLanguageView(t){const s=c=>x.getInstance().t(c);this.drawHeader(t,{title:s("language.title"),showBack:!0,onBack:()=>this.setView("list")});const i=x.getInstance().getAvailableLanguages().map(c=>({code:c,label:s(`language.${c}`)})),a=e(100),o=e(60),r=t-e(40),l=e(20),h=x.getInstance().getCurrentLanguage();i.forEach((c,u)=>{const w=a+u*(o+e(10)),d=c.code===h,C=d?"":"",g=this.createListItem(c.label,C,r,o,()=>{x.getInstance().setLanguage(c.code)});if(g.container.position.set(l,w),d){g.bg.clear();const f=o/2;g.bg.roundRect(0,0,r,o,f),g.bg.stroke({width:2,color:3646697}),g.bg.fill(15792383),g.icon.style.fill="#37A4E9"}g.chevron.visible=!1,this.card.addChild(g.container)})}drawHeader(t,s){const n=e(60),i=new m({text:s.title,style:{fontFamily:"Arial",fontSize:e(24),fill:"#333333",fontWeight:"bold"}});if(i.anchor.set(.5),i.position.set(t/2,n/2),this.card.addChild(i),s.showBack&&s.onBack){const o=new A,r=new S;r.rect(0,0,e(40),e(40)),r.fill({color:16777215,alpha:.001}),o.addChild(r);const l=b.createIcon("",e(24),"#555555");l.anchor.set(.5),l.position.set(e(20),e(20)+e(2)),o.addChild(l),o.position.set(e(10),(n-e(40))/2),o.eventMode="static",o.cursor="pointer",o.on("pointertap",s.onBack),this.card.addChild(o)}else if(!s.showBack){const o=new A,r=new S;r.rect(0,0,e(40),e(40)),r.fill({color:16777215,alpha:.001}),o.addChild(r);const l=new m({text:"×",style:{fontFamily:"Arial",fontSize:e(32),fill:"#AAAAAA"}});l.anchor.set(.5),l.position.set(e(20),e(20)+e(2)),o.addChild(l),o.position.set(t-e(50),(n-e(40))/2),o.eventMode="static",o.cursor="pointer",o.on("pointertap",this.onClose),this.card.addChild(o)}const a=new S;a.rect(0,n,t,1),a.fill(15658734),this.card.addChild(a)}createListItem(t,s,n,i,a){const o=new A,r=b.createPill(n,i,16382457);o.addChild(r);const l=b.createIcon(s,e(20),"#555555");l.anchor.set(.5),l.position.set(e(30),i/2+e(2)),o.addChild(l);const h=new m({text:t,style:{fontFamily:"Arial",fontSize:e(18),fill:"#333333"}});h.anchor.set(0,.5),h.position.set(e(60),i/2),o.addChild(h);const c=b.createIcon("",e(16),"#CCCCCC");return c.anchor.set(.5),c.position.set(n-e(20),i/2+e(2)),o.addChild(c),o.eventMode="static",o.cursor="pointer",o.on("pointertap",a),{container:o,bg:r,icon:l,label:h,chevron:c}}setView(t){this.currentView=t,this.refreshUI()}triggerFileUpload(){this.fileInputElement&&this.removeFileInput();const t=document.createElement("input");t.type="file",t.accept="image/*",t.style.display="none",document.body.appendChild(t),t.addEventListener("change",s=>{const n=s.target.files?.[0];if(n){const i=new FileReader;i.onload=a=>{const o=a.target?.result;if(o){const r=new Image;r.onerror=()=>{console.error("Failed to load uploaded image")},r.onload=()=>{let l=r.width,h=r.height;(l>D||h>D)&&(l>h?(h=Math.round(h*(D/l)),l=D):(l=Math.round(l*(D/h)),h=D));const c=document.createElement("canvas");c.width=l,c.height=h;const u=c.getContext("2d");if(u){u.drawImage(r,0,0,l,h);let w=0,d=1,C=c.toDataURL("image/jpeg",.1);for(let g=0;g<3;g++){const f=(w+d)/2,v=c.toDataURL("image/jpeg",f);(v.split(",")[1]||"").length*.75<=kt?(C=v,w=f):d=f}U.getInstance().updateUserProfile({avatarUrl:C}),this.refreshUI(),this.emit("profileUpdate")}},r.src=o}},i.readAsDataURL(n)}this.removeFileInput()}),t.click(),this.fileInputElement=t}removeFileInput(){this.fileInputElement&&(this.fileInputElement.parentNode&&this.fileInputElement.parentNode.removeChild(this.fileInputElement),this.fileInputElement=null)}destroy(t){window.removeEventListener("resize",this.handleResize),x.getInstance().unsubscribe(this.handleLanguageChange),this.removeFileInput(),super.destroy(t)}}class Ht extends A{onCloseCallback;onViewLevelsCallback;onLikeToggleCallback;onDeleteCallback;allowDelete;levelData;userColor;getThumbnail;constructor(t,s,n,i,a,o,r,l=!1){super(),this.levelData=t,this.userColor=s,this.getThumbnail=n,this.onCloseCallback=i,this.onViewLevelsCallback=a,this.onLikeToggleCallback=o,this.onDeleteCallback=r,this.allowDelete=l,this.refreshUI(),window.addEventListener("resize",this.handleResize)}handleResize=()=>{this.refreshUI()};refreshUI(){this.removeChildren();const t=k(),s=z();this.zIndex=2e3;const n=b.createOverlay(t,s,.5);n.eventMode="static",n.cursor="pointer",n.on("pointertap",()=>this.onCloseCallback()),this.addChild(n);const i=e(800),a=e(40),o=e(20),r=i-a*2-o,l=r*.6,h=r*.4,c=l,u=c*(9/16),w=e(80),d=u+w+a*2,C=b.createCard(i,d,16777215);C.position.set((t-i)/2,(s-d)/2),this.addChild(C),C.eventMode="static",C.on("pointertap",H=>H.stopPropagation());const g=new A;g.position.set(a,a),C.addChild(g);const f=new A,v=b.createShadow(c,u,0,8,.3);f.addChild(v);const p=new S;p.rect(0,0,c,u),p.fill(16119285),p.stroke({width:1,color:15658734}),f.addChild(p);const I=new S;I.rect(0,0,c,u),I.fill(16777215),f.addChild(I);const T=this.getThumbnail(c,u);T.mask=I,f.addChild(T),g.addChild(f);const F=new A;F.position.set(0,u+e(15)),g.addChild(F);const y=new A;F.addChild(y);const B=H=>x.getInstance().t(H),_=new J({fontFamily:"Arial",fontSize:e(14),fill:"#888888"}),M=new J({fontFamily:"Arial",fontSize:e(14),fontWeight:"bold",fill:"#555555"}),E=(H,wt,vt)=>{const Z=new A,ct=new m({text:H,style:_}),dt=new m({text:wt,style:M});return dt.x=ct.width+e(5),Z.addChild(ct,dt),Z.y=vt,Z},L=this.levelData.isPublished?new Date(this.levelData.createdAt||Date.now()).toLocaleDateString():this.levelData.createdAt?new Date(this.levelData.createdAt).toLocaleDateString():"-",W=this.levelData.isPublished?B("level.published"):B("level.created");y.addChild(E(W,L,0));const j=this.levelData.attempts??0;y.addChild(E(B("level.attempts"),j.toString(),e(25)));const et=this.levelData.clears??0,ft=j>0?Math.round(et/j*100):0;y.addChild(E(B("level.clears"),`${et} (${ft}%)`,e(50)));const it=e(100),st=e(36),nt=this.createLikeButton(this.levelData.likes||0,it,st);nt.position.set(c-it,(e(75)-st)/2),F.addChild(nt);const R=new A;R.position.set(a+l+o,a),C.addChild(R);const ot=u+w,X=h,pt=b.createCard(X,ot,16777215);R.addChild(pt);const Y=X/2,$=e(70);let G=e(30),at=this.userColor,rt;if(this.levelData.authorId===P){const H=U.getInstance().getUserProfile();at=H.avatarColor,rt=H.avatarUrl}const lt=b.createAvatar($,rt,at);lt.position.set(Y,G+$),R.addChild(lt),G+=$*2+e(15);const Ct=this.levelData.author||"Unknown",N=new m({text:Ct,style:{fontFamily:"Arial",fontSize:e(20),fontWeight:"bold",fill:"#555555",align:"center",wordWrap:!0,wordWrapWidth:X-e(20)}});N.anchor.set(.5,0),N.position.set(Y,G),R.addChild(N),G+=N.height+e(5);const K=new m({text:B("profile.total_levels")+"42",style:{fontFamily:"Arial",fontSize:e(14),fill:"#AAAAAA",align:"center"}});K.anchor.set(.5,0),K.position.set(Y,G),R.addChild(K);const ht=this.levelData.authorId===P&&this.allowDelete?this.createDeleteButton(X-e(40)):this.createViewLevelsButton(X-e(40));ht.position.set(Y,ot-e(30)),R.addChild(ht);const V=new A,O=e(40),Q=new S;Q.rect(0,0,O,O),Q.fill({color:16777215,alpha:.001}),V.addChild(Q);const q=new m({text:"×",style:{fontFamily:"Arial",fontSize:e(32),fill:"#AAAAAA"}});q.anchor.set(.5),q.position.set(O/2,O/2),V.addChild(q),V.position.set(i-O-e(5),e(5)),V.eventMode="static",V.cursor="pointer",V.on("pointertap",()=>this.onCloseCallback()),C.addChild(V)}createLikeButton(t,s,n){const i=new A,a=s,o=n||e(36),r=o/2,l=b.createPill(a,o,16777215,16739179,2);i.addChild(l);const h=b.createIcon("",e(20),"#FF6B6B");i.addChild(h);let c=t;const u=new m({text:c.toString(),style:{fontFamily:"Arial",fontSize:e(24),fill:"#FF6B6B",fontWeight:"bold"}});u.anchor.set(0,.5),i.addChild(u);const w=()=>{const f=e(12),v=h.width+f+u.width,p=(a-v)/2;h.position.set(p+h.width/2,o/2+e(2)),u.position.set(p+h.width+f,o/2)};w(),i.eventMode="static",i.cursor="pointer";let d=!!this.levelData.isLikedByCurrentUser;const C=d?t-1:t,g=()=>{const f=C+(d?1:0);u.text=f.toString(),w(),d?(l.clear(),l.roundRect(0,0,a,o,r),l.fill({color:16739179}),h.style.fill="#FFFFFF",u.style.fill="#FFFFFF"):(l.clear(),l.roundRect(0,0,a,o,r),l.stroke({width:2,color:16739179}),l.fill({color:16777215}),h.style.fill="#FF6B6B",u.style.fill="#FF6B6B")};return g(),i.on("pointertap",()=>{d=!d,this.levelData.isLikedByCurrentUser=d,this.levelData.likes=C+(d?1:0),this.onLikeToggleCallback&&this.onLikeToggleCallback(),g()}),i}createViewLevelsButton(t){const s=t,n=e(36),i=b.createButton(x.getInstance().t("profile.view_levels"),s,n,3646697,"#FFFFFF",()=>{this.levelData.authorId&&this.onViewLevelsCallback(this.levelData.authorId)},14);return i.pivot.set(s/2,n/2),i}createDeleteButton(t){const s=t,n=e(36),i=new A,a=b.createPill(s,n,16777215,16739179,1);a.position.set(-s/2,-n/2),i.addChild(a);const o=new m({text:x.getInstance().t("level.delete"),style:{fontFamily:"Arial",fontSize:e(14),fill:"#FF6B6B",fontWeight:"bold"}});return o.anchor.set(.5),i.addChild(o),i.eventMode="static",i.cursor="pointer",i.on("pointertap",()=>{if(this.onDeleteCallback){const r=new At(x.getInstance().t("level.delete_confirm"),()=>{this.onDeleteCallback&&this.onDeleteCallback(this.levelData.id),this.removeChild(r),r.destroy()},()=>{this.removeChild(r),r.destroy()},{confirmKey:"level.delete",cancelKey:"common.cancel"});this.addChild(r)}}),i}destroy(t){window.removeEventListener("resize",this.handleResize),super.destroy(t)}}class Rt extends A{levels;onSelect;onCreate;currentPage=0;totalPages=0;laserTexture;gridContainer;headerContainer;isDragging=!1;dragStartX=0;dragStartPageX=0;dragDistance=0;scrollTweenId=0;penSelectionUI=null;settingsUI=null;userProfileCard=null;onPenSelect;currentPenId="pen_default";sortMode="latest";filterAuthorId=null;visibleLevels=[];filterAuthorName=null;filterAuthorColor=8947848;latestBtnText;popularBtnText;mineBtnText;filterFilterTagContainer;createLevelBtn;HEADER_HEIGHT_RATIO=1/5;COLS=3;ROWS=2;ITEMS_PER_PAGE=6;CARD_ASPECT_RATIO=16/9;backgroundHitArea=null;constructor(t,s,n,i,a,o){super(),this.levels=t,this.onSelect=s,this.onCreate=n,this.laserTexture=i,this.onPenSelect=a,o&&(this.currentPenId=o),this.totalPages=Math.ceil(t.length/this.ITEMS_PER_PAGE),this.headerContainer=new A,this.gridContainer=new A,this.addChild(this.gridContainer),this.addChild(this.headerContainer),this.setupHeader(),this.refreshVisibleLevels(),this.setupInteraction(),x.getInstance().subscribe(()=>{this.headerContainer.removeChildren(),this.setupHeader(),this.setupGrid()})}setupHeader(){const t=v=>x.getInstance().t(v),s=k(),n=this.getHeaderHeight(),i=new J({fontFamily:"Arial",fontSize:e(60),fontWeight:"bold",fill:"#555555"}),a=new m({text:t("app.title"),style:i});a.position.set(e(60),(n-a.height)/2),this.headerContainer.addChild(a);const o=(n+e(10))/2;this.latestBtnText=this.createSortButton(t("sort.latest"),0,o,"latest"),this.headerContainer.addChild(this.latestBtnText),this.popularBtnText=this.createSortButton(t("sort.popular"),0,o,"popular"),this.headerContainer.addChild(this.popularBtnText),this.mineBtnText=this.createHeaderInteractiveText(t("sort.mine"),0,o,()=>{this.filterAuthorId===P?this.setFilterAuthor(null):this.setFilterAuthor(P)}),this.headerContainer.addChild(this.mineBtnText);const r=e(40),l=this.latestBtnText.width+r+this.popularBtnText.width+r+this.mineBtnText.width,h=(s-l)/2;this.latestBtnText.x=h,this.popularBtnText.x=h+this.latestBtnText.width+r,this.mineBtnText.x=h+this.latestBtnText.width+r+this.popularBtnText.width+r,this.filterFilterTagContainer=new A,this.filterFilterTagContainer=new A,this.headerContainer.addChild(this.filterFilterTagContainer),this.updateFilterTag();const c=e(36),u=e(52),w=e(20),d=this.createHeaderButton(""),C=s-e(20)-u;d.position.set(C,c),d.on("pointertap",()=>this.showSettings()),this.headerContainer.addChild(d);const g=this.createHeaderButton(""),f=C-w-u;g.position.set(f,c),g.on("pointertap",()=>this.showPenSelection()),this.headerContainer.addChild(g),this.createLevelBtn=this.createFloatingActionButton(),this.createLevelBtn.visible=!1,this.addChild(this.createLevelBtn),this.updateSortButtons()}getHeaderHeight(){return z()*this.HEADER_HEIGHT_RATIO}createFloatingActionButton(){const t=e(64),s=new A,n=new S;n.circle(0,0,t/2),n.fill(5592405),s.addChild(n);const i=new m({text:"+",style:{fontFamily:"Arial",fontSize:e(40),fill:"#FFFFFF",fontWeight:"bold"}});return i.anchor.set(.5),i.position.set(0,0),s.addChild(i),s.position.set(k()-e(50),z()-e(50)),s.eventMode="static",s.cursor="pointer",s.on("pointertap",()=>{console.log("Create Level Attempt"),this.onCreate()}),s}createSortButton(t,s,n,i){return this.createHeaderInteractiveText(t,s,n,()=>{this.setSortMode(i)})}createHeaderInteractiveText(t,s,n,i){const a=new m({text:t,style:{fontFamily:"Arial",fontSize:e(24),fill:"#AAAAAA",fontWeight:"normal"}});return a.anchor.set(0,.5),a.position.set(s,n),a.eventMode="static",a.cursor="pointer",a.on("pointertap",i),a}updateSortButtons(){const t=this.filterAuthorId===P;if(this.latestBtnText){const s=this.sortMode==="latest"&&!t;this.latestBtnText.style.fill=s?"#555555":"#AAAAAA",this.latestBtnText.style.fontWeight=s?"bold":"normal"}if(this.popularBtnText){const s=this.sortMode==="popular"&&!t;this.popularBtnText.style.fill=s?"#555555":"#AAAAAA",this.popularBtnText.style.fontWeight=s?"bold":"normal"}if(this.mineBtnText){const s=t;this.mineBtnText.style.fill=s?"#555555":"#AAAAAA",this.mineBtnText.style.fontWeight=s?"bold":"normal"}this.createLevelBtn&&(this.createLevelBtn.visible=t)}createHeaderButton(t){const s=e(52),n=new A,i=new S;i.rect(0,0,s,s),i.fill({color:16777215,alpha:.001}),n.addChild(i);const a=b.createIcon(t,e(60),"#555555");return a.style.stroke={color:"#555555",width:.5},a.position.set(s/2,s/2+e(2)),n.addChild(a),n.eventMode="static",n.cursor="pointer",n}setupGrid(){this.gridContainer.removeChildren();const t=k();for(let s=0;s<this.totalPages;s++){const n=new A;n.x=s*t,this.gridContainer.addChild(n);const i=s*this.ITEMS_PER_PAGE,a=Math.min(i+this.ITEMS_PER_PAGE,this.visibleLevels.length);this.renderPage(n,i,a)}}renderPage(t,s,n){const i=k(),a=z(),o=this.getHeaderHeight(),r=i,l=a-o,h=r*.7/this.COLS,c=Math.floor(h),u=Math.floor(c/this.CARD_ASPECT_RATIO),w=(r-c*this.COLS)/(this.COLS+1),d=(l-u*this.ROWS)/(this.ROWS+1),C=o+d;for(let g=s;g<n;g++){const f=g-s,v=Math.floor(f/this.COLS),p=f%this.COLS,I=w+p*(c+w),T=C+v*(u+d),F=this.createLevelCard(g,this.visibleLevels[g],c,u);F.position.set(I,T),t.addChild(F)}}createLevelCard(t,s,n,i){const a=new A,o=b.createShadow(n,i,0,8,.3);a.addChild(o);const r=b.createCardBackground(n,i,16777215);a.addChild(r);const l=this.createLevelThumbnail(s,n,i),h=new S;if(h.rect(0,0,n,i),h.fill(16777215),l.mask=h,a.addChild(h),a.addChild(l),s.authorId===P&&s.isPublished===!1){const p=new S;p.rect(0,0,n,i),p.fill({color:0,alpha:.2}),a.addChild(p);const I=new A,T=new S;let F="",y=0,B="#FFFFFF";s.authorPassed?(F=x.getInstance().t("status.draft"),y=8947848,B="#FFFFFF"):(F=x.getInstance().t("status.untested"),y=15658734,B="#888888");const _=e(24),M=e(12),E=e(20),L=new m({text:F,style:{fontFamily:"Arial",fontSize:e(12),fill:B,fontWeight:"bold"}}),W=Math.max(e(60),L.width+E);T.roundRect(0,0,W,_,M),T.fill(y),L.anchor.set(.5),L.position.set(W/2,_/2),I.addChild(T),I.addChild(L),I.position.set(e(10),e(10)),a.addChild(I)}else{const p=s.likes||0,I=new A,T=new m({text:p.toString(),style:{fontFamily:"Arial",fontSize:e(12),fill:"#FFFFFF",fontWeight:"bold"}}),F=e(10),y=e(14),B=e(4),_=F+y+B+T.width+F,M=e(24),E=e(12),L=new S;L.roundRect(0,0,_,M,E),L.fill({color:0,alpha:.4}),I.addChild(L);const W=b.createIcon("",y,"#FFFFFF");W.position.set(F+y/2,M/2+e(2)),I.addChild(W),T.anchor.set(0,.5),T.position.set(F+y+B,M/2),I.addChild(T),I.position.set(e(12),e(12)),a.addChild(I)}const c=e(25),u=[16739179,5164484,4569041,16760438,16742777,12246104],w=s.authorId||s.author||"unknown";let d=0;for(let p=0;p<w.length;p++)d=w.charCodeAt(p)+((d<<5)-d);const C=Math.abs(d)%u.length;let g=u[C],f;if(s.authorId===P){const p=U.getInstance().getUserProfile();g=p.avatarColor,f=p.avatarUrl}const v=b.createAvatar(c,f,g,16777215);return v.position.set(n-e(4),i-e(4)),v.eventMode="static",v.cursor="pointer",v.on("pointertap",p=>{p.stopPropagation(),this.showUserProfile(s,g)}),a.addChild(v),a.addChild(v),a.eventMode="static",a.cursor="pointer",a.on("pointertap",()=>{this.dragDistance<10&&this.onSelect(s)}),a}createLevelThumbnail(t,s,n){const i=new A,a=Math.min(s/Pt,n/Lt);if(i.scale.set(a),t.obstacles&&t.obstacles.forEach(o=>i.addChild(It.createVisual(o))),t.fallingObjects&&t.fallingObjects.forEach(o=>i.addChild(bt.createVisual(o))),t.nets&&t.nets.forEach(o=>i.addChild(mt.createVisual(o))),t.iceBlocks&&t.iceBlocks.forEach(o=>i.addChild(Ft.createVisual(o))),t.lasers&&this.laserTexture&&t.lasers.forEach(o=>i.addChild(St.createVisual(o,this.laserTexture,14))),t.seesaws&&t.seesaws.forEach(o=>i.addChild(xt.createVisual(o))),t.conveyors&&t.conveyors.forEach(o=>i.addChild(Tt.createVisual(o))),t.buttons&&t.buttons.forEach(o=>i.addChild(yt.createVisual(o))),t.balls){const o=gt.createVisual(t.balls.blue.x,t.balls.blue.y,"blue"),r=gt.createVisual(t.balls.pink.x,t.balls.pink.y,"pink");i.addChild(o),i.addChild(r)}return i}setupInteraction(){const t=k(),s=z(),n=this.getHeaderHeight();this.backgroundHitArea=new S,this.backgroundHitArea.rect(0,n,t,s-n),this.backgroundHitArea.fill({color:0,alpha:0}),this.addChildAt(this.backgroundHitArea,0),this.eventMode="static",this.on("pointerdown",i=>{if(this.penSelectionUI||this.userProfileCard||this.settingsUI)return;const a=this.getHeaderHeight();this.toLocal(i.global).y<a||(this.isDragging=!0,this.dragStartX=i.global.x,this.dragDistance=0,this.dragStartPageX=this.gridContainer.x)}),this.on("pointermove",i=>{if(!this.isDragging)return;const o=i.global.x-this.dragStartX;this.dragDistance=Math.max(this.dragDistance,Math.abs(o)),this.gridContainer.x=this.dragStartPageX+o}),this.on("pointerup",i=>this.endDrag(i)),this.on("pointerupoutside",i=>this.endDrag(i))}endDrag(t){if(!this.isDragging)return;this.isDragging=!1;const n=t.global.x-this.dragStartX;Math.abs(n)>50&&(n>0&&this.currentPage>0?this.currentPage--:n<0&&this.currentPage<this.totalPages-1&&this.currentPage++),this.scrollToPage(this.currentPage)}scrollToPage(t){const s=k(),n=-t*s,i=this.gridContainer.x,a=n-i,o=.3,r=Date.now(),l=++this.scrollTweenId,h=()=>{if(this.scrollTweenId!==l)return;const c=Date.now(),u=Math.min((c-r)/(o*1e3),1),w=1-Math.pow(1-u,3);this.gridContainer.x=i+a*w,u<1&&requestAnimationFrame(h)};h()}showPenSelection(){this.penSelectionUI&&(this.removeChild(this.penSelectionUI),this.penSelectionUI.destroy(),this.penSelectionUI=null),this.penSelectionUI=new Bt(t=>{this.onPenSelect&&this.onPenSelect(t),this.currentPenId=t.id,this.closePenSelection()},()=>this.closePenSelection(),this.currentPenId),this.penSelectionUI.zIndex=1e3,this.addChild(this.penSelectionUI)}closePenSelection(){this.penSelectionUI&&(this.removeChild(this.penSelectionUI),this.penSelectionUI.destroy(),this.penSelectionUI=null)}showSettings(){this.settingsUI&&(this.removeChild(this.settingsUI),this.settingsUI.destroy(),this.settingsUI=null),this.settingsUI=new Ut(()=>this.closeSettings()),this.settingsUI.zIndex=2e3,this.settingsUI.on("profileUpdate",()=>{U.getInstance().getLevelList().then(t=>{this.levels=t,this.refreshVisibleLevels()})}),this.addChild(this.settingsUI)}closeSettings(){this.settingsUI&&(this.removeChild(this.settingsUI),this.settingsUI.destroy(),this.settingsUI=null,U.getInstance().getLevelList().then(t=>{this.levels=t,this.refreshVisibleLevels()}))}showUserProfile(t,s){this.userProfileCard&&(this.removeChild(this.userProfileCard),this.userProfileCard.destroy(),this.userProfileCard=null),this.userProfileCard=new Ht(t,s,(n,i)=>this.createLevelThumbnail(t,n,i),()=>this.closeUserProfile(),n=>{this.closeUserProfile(),this.setFilterAuthor(n,t.author||"",s)},()=>{U.getInstance().toggleLike(t.id),this.setupGrid()},n=>{U.getInstance().deleteLevel(n),this.closeUserProfile(),this.levels=this.levels.filter(i=>i.id!==n),this.refreshVisibleLevels()},this.filterAuthorId===P),this.addChild(this.userProfileCard)}closeUserProfile(){this.userProfileCard&&(this.removeChild(this.userProfileCard),this.userProfileCard.destroy(),this.userProfileCard=null)}setPen(t){this.currentPenId=t}setSortMode(t){if(this.filterAuthorId===P&&this.setFilterAuthor(null),this.sortMode===t&&this.filterAuthorId===null){this.currentPage!==0&&(this.currentPage=0,this.scrollToPage(0));return}this.sortMode=t,this.updateSortButtons(),this.refreshVisibleLevels()}setFilterAuthor(t,s,n){this.filterAuthorId!==t&&(this.filterAuthorId=t,t?(this.filterAuthorName=s||`User ${t.slice(0,4)}`,this.filterAuthorColor=n||8947848,t===P&&(this.sortMode="latest")):this.filterAuthorName=null,this.updateSortButtons(),this.updateFilterTag(),this.refreshVisibleLevels())}updateFilterTag(){if(!this.filterFilterTagContainer)return;if(this.filterFilterTagContainer.removeChildren(),!this.filterAuthorId||this.filterAuthorId===P){this.filterFilterTagContainer.visible=!1;return}this.filterFilterTagContainer.visible=!0;const t=e(40),s=e(6),n=e(12),i=e(8),a=e(28),o=e(16),r=e(14),l=16777215,h=14737632,c=3355443,u=10066329,w=16119285,d=new S,C=new S;C.circle(0,0,a/2),C.fill(this.filterAuthorColor),C.position.set(s+a/2,t/2);const g=new m({text:this.filterAuthorName||"Unknown",style:{fontFamily:"Arial",fontSize:o,fill:c,fontWeight:"bold"}});g.anchor.set(0,.5),g.position.set(s+a+i,t/2);const f=new m({text:"✕",style:{fontFamily:"Arial",fontSize:e(14),fill:u,fontWeight:"bold"}});f.anchor.set(.5);const v=s+a+i+g.width+i+r+n;d.roundRect(0,0,v,t,t/2),d.fill(l),d.stroke({width:1,color:h}),f.position.set(v-n-r/2,t/2),this.filterFilterTagContainer.addChild(d),this.filterFilterTagContainer.addChild(C),this.filterFilterTagContainer.addChild(g),this.filterFilterTagContainer.addChild(f);const p=k(),T=(z()*this.HEADER_HEIGHT_RATIO+e(10))/2;if(this.mineBtnText)this.filterFilterTagContainer.x=this.mineBtnText.x+this.mineBtnText.width+e(30);else{const F=p/2;this.filterFilterTagContainer.x=F+e(200)}this.filterFilterTagContainer.y=T-t/2,this.filterFilterTagContainer.eventMode="static",this.filterFilterTagContainer.cursor="pointer",this.filterFilterTagContainer.on("pointerover",()=>{d.clear(),d.roundRect(0,0,v,t,t/2),d.fill(w),d.stroke({width:1,color:h})}),this.filterFilterTagContainer.on("pointerout",()=>{d.clear(),d.roundRect(0,0,v,t,t/2),d.fill(l),d.stroke({width:1,color:h})}),this.filterFilterTagContainer.on("pointertap",()=>{this.setFilterAuthor(null)})}refreshVisibleLevels(){let t=this.levels;const s=this.filterAuthorId;s===P?t=t.filter(n=>n.authorId===s):s?t=t.filter(n=>(n.authorId===s||!n.authorId&&s.startsWith("mock_user"))&&n.isPublished!==!1):t=t.filter(n=>n.isPublished!==!1),t=[...t],this.sortMode==="popular"?t.sort((n,i)=>(i.likes||0)-(n.likes||0)):t.sort((n,i)=>(i.createdAt||0)-(n.createdAt||0)),this.visibleLevels=t,this.scrollTweenId++,this.currentPage=0,this.totalPages=Math.ceil(this.visibleLevels.length/this.ITEMS_PER_PAGE),this.totalPages===0&&(this.totalPages=1),this.gridContainer.x=0,this.setupGrid()}updateLayout(){this.headerContainer.removeChildren(),this.createLevelBtn&&(this.removeChild(this.createLevelBtn),this.createLevelBtn.destroy({children:!0}),this.createLevelBtn=void 0),this.backgroundHitArea&&(this.removeChild(this.backgroundHitArea),this.backgroundHitArea.destroy(),this.backgroundHitArea=null),this.setupHeader(),this.setupGrid(),this.setupInteraction(),this.currentPage>=this.totalPages&&(this.currentPage=Math.max(0,this.totalPages-1)),this.gridContainer.x=-this.currentPage*k(),this.penSelectionUI,this.userProfileCard}updateLevels(t){this.levels=t,this.refreshVisibleLevels()}}export{Rt as LevelSelectionUI};
