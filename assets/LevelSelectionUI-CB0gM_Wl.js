import{C as p,G as x,g as k,a as z,U as T,s as e,L as P,T as F,b as Q,c as _,d as wt,O as vt,F as bt,N as It,I as At,e as St,S as Ft,f as Tt,B as mt,h as dt,P as xt,D as yt,i as Bt}from"./Game-DyxRg_Ti.js";import{LanguageManager as B}from"./LanguageManager-BhWXvVLp.js";import"./index-BSJEPds-.js";class Pt extends p{onClose;currentView="list";overlay;card;constructor(t){super(),this.onClose=t,this.overlay=new x,this.card=new p,this.addChild(this.overlay),this.addChild(this.card),this.refreshUI(),window.addEventListener("resize",this.handleResize),B.getInstance().subscribe(this.handleLanguageChange)}handleLanguageChange=()=>{this.refreshUI()};handleResize=()=>{this.refreshUI()};refreshUI(){const t=k(),n=z();this.overlay.clear(),this.overlay.rect(0,0,t,n),this.overlay.fill({color:0,alpha:.5}),this.overlay.eventMode="static",this.overlay.cursor="default",this.overlay.off("pointertap",this.onClose),this.overlay.on("pointertap",this.onClose),this.card.removeChildren();const s=e(600),i=e(500),r=(t-s)/2,o=(n-i)/2;this.card=T.createCard(s,i,16777215,0),this.card.position.set(r,o),this.addChild(this.card),this.card.eventMode="static",this.card.on("pointertap",a=>a.stopPropagation()),this.currentView==="list"?this.drawListView(s):this.currentView==="profile"?this.drawProfileView(s):this.currentView==="language"&&this.drawLanguageView(s)}drawListView(t){const n=l=>B.getInstance().t(l),s={title:n("settings.title"),showBack:!1};this.drawHeader(t,s);const i=e(100),r=e(60),o=t-e(40),a=e(20);[{label:n("settings.profile"),onClick:()=>this.setView("profile"),icon:""},{label:n("settings.language"),onClick:()=>this.setView("language"),icon:""},{label:n("settings.github"),onClick:()=>{window.open("https://github.com/wangicheng/opendots","_blank")},icon:""}].forEach((l,c)=>{const g=i+c*(r+e(10)),b=this.createListItem(l.label,l.icon,o,r,l.onClick);b.container.position.set(a,g),this.card.addChild(b.container)})}drawProfileView(t){const n=I=>B.getInstance().t(I);this.drawHeader(t,{title:n("profile.title"),showBack:!0,onBack:()=>this.setView("list")});const s=P.getInstance(),i=s.isLoggedIn(),r=s.getUserProfile(),o=t/2;if(!i||!r){const I=new F({text:`Sign in with Google to create levels, 
like levels, and sync your profile.`,style:{fontFamily:"Arial",fontSize:e(16),fill:"#555555",align:"center",wordWrap:!0,wordWrapWidth:t-e(80)}});I.anchor.set(.5),I.position.set(o,e(150)),this.card.addChild(I);const w=e(250),S=e(50),v=new p,m=new x;m.roundRect(-w/2,-S/2,w,S,S/2),m.fill(16777215),m.stroke({width:1,color:13421772});const y=new F({text:"Sign in with Google",style:{fontFamily:"Arial",fontSize:e(18),fill:"#555555",fontWeight:"bold"}});y.anchor.set(.5),v.addChild(m),v.addChild(y),v.position.set(o,e(250)),v.eventMode="static",v.cursor="pointer",v.on("pointertap",()=>{s.loginWithGoogle("")}),this.card.addChild(v);return}const a=e(120),h=e(50),l=T.createAvatar(h,r.avatarUrl,r.avatarColor,14737632);l.position.set(o,a),this.card.addChild(l);const c=a+h+e(40),g=new F({text:r.name,style:{fontFamily:"Arial",fontSize:e(24),fill:"#333333",fontWeight:"bold"}});g.anchor.set(.5),g.position.set(o,c),this.card.addChild(g);const b=c+e(60),d=new p,f=e(120),u=e(40),C=new x;C.roundRect(-f/2,-u/2,f,u,u/2),C.fill(16772846),C.stroke({width:1,color:16711680});const A=new F({text:"Logout",style:{fontFamily:"Arial",fontSize:e(16),fill:"#FF0000"}});A.anchor.set(.5),d.addChild(C),d.addChild(A),d.position.set(o,b),d.eventMode="static",d.cursor="pointer",d.on("pointertap",()=>{s.logout(),this.refreshUI()}),this.card.addChild(d)}drawLanguageView(t){const n=c=>B.getInstance().t(c);this.drawHeader(t,{title:n("language.title"),showBack:!0,onBack:()=>this.setView("list")});const i=B.getInstance().getAvailableLanguages().map(c=>({code:c,label:n(`language.${c}`)})),r=e(100),o=e(60),a=t-e(40),h=e(20),l=B.getInstance().getCurrentLanguage();i.forEach((c,g)=>{const b=r+g*(o+e(10)),d=c.code===l,f=d?"":"",u=this.createListItem(c.label,f,a,o,()=>{B.getInstance().setLanguage(c.code)});if(u.container.position.set(h,b),d){u.bg.clear();const C=o/2;u.bg.roundRect(0,0,a,o,C),u.bg.stroke({width:2,color:3646697}),u.bg.fill(15792383),u.icon.style.fill="#37A4E9"}u.chevron.visible=!1,this.card.addChild(u.container)})}drawHeader(t,n){const s=e(60),i=new F({text:n.title,style:{fontFamily:"Arial",fontSize:e(24),fill:"#333333",fontWeight:"bold"}});if(i.anchor.set(.5),i.position.set(t/2,s/2),this.card.addChild(i),n.showBack&&n.onBack){const o=new p,a=new x;a.rect(0,0,e(40),e(40)),a.fill({color:16777215,alpha:.001}),o.addChild(a);const h=T.createIcon("",e(24),"#555555");h.anchor.set(.5),h.position.set(e(20),e(20)+e(2)),o.addChild(h),o.position.set(e(10),(s-e(40))/2),o.eventMode="static",o.cursor="pointer",o.on("pointertap",n.onBack),this.card.addChild(o)}else if(!n.showBack){const o=new p,a=new x;a.rect(0,0,e(40),e(40)),a.fill({color:16777215,alpha:.001}),o.addChild(a);const h=new F({text:"×",style:{fontFamily:"Arial",fontSize:e(32),fill:"#AAAAAA"}});h.anchor.set(.5),h.position.set(e(20),e(20)+e(2)),o.addChild(h),o.position.set(t-e(50),(s-e(40))/2),o.eventMode="static",o.cursor="pointer",o.on("pointertap",this.onClose),this.card.addChild(o)}const r=new x;r.rect(0,s,t,1),r.fill(15658734),this.card.addChild(r)}createListItem(t,n,s,i,r){const o=new p,a=T.createPill(s,i,16382457);o.addChild(a);const h=T.createIcon(n,e(20),"#555555");h.anchor.set(.5),h.position.set(e(30),i/2+e(2)),o.addChild(h);const l=new F({text:t,style:{fontFamily:"Arial",fontSize:e(18),fill:"#333333"}});l.anchor.set(0,.5),l.position.set(e(60),i/2),o.addChild(l);const c=T.createIcon("",e(16),"#CCCCCC");return c.anchor.set(.5),c.position.set(s-e(20),i/2+e(2)),o.addChild(c),o.eventMode="static",o.cursor="pointer",o.on("pointertap",r),{container:o,bg:a,icon:h,label:l,chevron:c}}setView(t){this.currentView=t,this.refreshUI()}destroy(t){window.removeEventListener("resize",this.handleResize),B.getInstance().unsubscribe(this.handleLanguageChange),super.destroy(t)}}class Lt extends p{onCloseCallback;onViewLevelsCallback;onLikeToggleCallback;onDeleteCallback;allowDelete;levelData;userColor;getThumbnail;authorLevelCount;constructor(t,n,s,i,r,o,a,h=!1,l=0){super(),this.levelData=t,this.userColor=n,this.getThumbnail=s,this.onCloseCallback=i,this.onViewLevelsCallback=r,this.onLikeToggleCallback=o,this.onDeleteCallback=a,this.allowDelete=h,this.authorLevelCount=l,this.refreshUI(),window.addEventListener("resize",this.handleResize)}handleResize=()=>{this.refreshUI()};refreshUI(){this.removeChildren();const t=k(),n=z();this.zIndex=2e3;const s=T.createOverlay(t,n,.5);s.eventMode="static",s.cursor="pointer",s.on("pointertap",()=>this.onCloseCallback()),this.addChild(s);const i=e(800),r=e(40),o=e(20),a=i-r*2-o,h=a*.6,l=a*.4,c=h,g=c*(9/16),b=e(80),d=g+b+r*2,f=T.createCard(i,d,16777215);f.position.set((t-i)/2,(n-d)/2),this.addChild(f),f.eventMode="static",f.on("pointertap",W=>W.stopPropagation());const u=new p;u.position.set(r,r),f.addChild(u);const C=new p,A=T.createShadow(c,g,0,8,.3);C.addChild(A);const I=new x;I.rect(0,0,c,g),I.fill(16119285),I.stroke({width:1,color:15658734}),C.addChild(I);const w=new x;w.rect(0,0,c,g),w.fill(16777215),C.addChild(w);const S=this.getThumbnail(c,g);S.mask=w,C.addChild(S),u.addChild(C);const v=new p;v.position.set(0,g+e(15)),u.addChild(v);const m=new p;v.addChild(m);const y=W=>B.getInstance().t(W),M=new Q({fontFamily:"Arial",fontSize:e(14),fill:"#888888"}),V=new Q({fontFamily:"Arial",fontSize:e(14),fontWeight:"bold",fill:"#555555"}),H=(W,Ct,pt)=>{const J=new p,ht=new F({text:W,style:M}),ct=new F({text:Ct,style:V});return ct.x=ht.width+e(5),J.addChild(ht,ct),J.y=pt,J},D=this.levelData.isPublished?new Date(this.levelData.createdAt||Date.now()).toLocaleDateString():this.levelData.createdAt?new Date(this.levelData.createdAt).toLocaleDateString():"-",L=this.levelData.isPublished?y("level.published"):y("level.created");m.addChild(H(L,D,0));const U=this.levelData.attempts??0;m.addChild(H(y("level.attempts"),U.toString(),e(25)));const tt=this.levelData.clears??0,gt=U>0?Math.round(tt/U*100):0;m.addChild(H(y("level.clears"),`${tt} (${gt}%)`,e(50)));const et=e(100),it=e(36),st=this.createLikeButton(this.levelData.likes||0,et,it);st.position.set(c-et,(e(75)-it)/2),v.addChild(st);const E=new p;E.position.set(r+h+o,r),f.addChild(E);const nt=g+b,X=l,ut=T.createCard(X,nt,16777215);E.addChild(ut);const Y=X/2,$=e(70);let G=e(30),ot=this.userColor,rt;if(this.levelData.authorId===_){const W=P.getInstance().getUserProfile();W&&(ot=W.avatarColor,rt=W.avatarUrl)}const at=T.createAvatar($,rt,ot);at.position.set(Y,G+$),E.addChild(at),G+=$*2+e(15);const ft=this.levelData.author||"Unknown",N=new F({text:ft,style:{fontFamily:"Arial",fontSize:e(20),fontWeight:"bold",fill:"#555555",align:"center",wordWrap:!0,wordWrapWidth:X-e(20)}});N.anchor.set(.5,0),N.position.set(Y,G),E.addChild(N),G+=N.height+e(5);const j=new F({text:y("profile.total_levels")+this.authorLevelCount.toString(),style:{fontFamily:"Arial",fontSize:e(14),fill:"#AAAAAA",align:"center"}});j.anchor.set(.5,0),j.position.set(Y,G),E.addChild(j);const lt=this.levelData.authorId===_&&this.allowDelete?this.createDeleteButton(X-e(40)):this.createViewLevelsButton(X-e(40));lt.position.set(Y,nt-e(30)),E.addChild(lt);const R=new p,O=e(40),K=new x;K.rect(0,0,O,O),K.fill({color:16777215,alpha:.001}),R.addChild(K);const q=new F({text:"×",style:{fontFamily:"Arial",fontSize:e(32),fill:"#AAAAAA"}});q.anchor.set(.5),q.position.set(O/2,O/2),R.addChild(q),R.position.set(i-O-e(5),e(5)),R.eventMode="static",R.cursor="pointer",R.on("pointertap",()=>this.onCloseCallback()),f.addChild(R)}createLikeButton(t,n,s){const i=new p,r=n,o=s||e(36),a=o/2,h=T.createPill(r,o,16777215,16739179,2);i.addChild(h);const l=T.createIcon("",e(20),"#FF6B6B");i.addChild(l);let c=t;const g=new F({text:c.toString(),style:{fontFamily:"Arial",fontSize:e(24),fill:"#FF6B6B",fontWeight:"bold"}});g.anchor.set(0,.5),i.addChild(g);const b=()=>{const C=e(12),A=l.width+C+g.width,I=(r-A)/2;l.position.set(I+l.width/2,o/2+e(2)),g.position.set(I+l.width+C,o/2)};b(),i.eventMode="static",i.cursor="pointer";let d=!!this.levelData.isLikedByCurrentUser;const f=d?t-1:t,u=()=>{const C=f+(d?1:0);g.text=C.toString(),b(),d?(h.clear(),h.roundRect(0,0,r,o,a),h.fill({color:16739179}),l.style.fill="#FFFFFF",g.style.fill="#FFFFFF"):(h.clear(),h.roundRect(0,0,r,o,a),h.stroke({width:2,color:16739179}),h.fill({color:16777215}),l.style.fill="#FF6B6B",g.style.fill="#FF6B6B")};return u(),i.on("pointertap",()=>{d=!d,this.levelData.isLikedByCurrentUser=d,this.levelData.likes=f+(d?1:0),this.onLikeToggleCallback&&this.onLikeToggleCallback(),u()}),i}createViewLevelsButton(t){const n=t,s=e(36),i=T.createButton(B.getInstance().t("profile.view_levels"),n,s,3646697,"#FFFFFF",()=>{this.levelData.authorId&&this.onViewLevelsCallback(this.levelData.authorId)},14);return i.pivot.set(n/2,s/2),i}createDeleteButton(t){const n=t,s=e(36),i=new p,r=T.createPill(n,s,16777215,16739179,1);r.position.set(-n/2,-s/2),i.addChild(r);const o=new F({text:B.getInstance().t("level.delete"),style:{fontFamily:"Arial",fontSize:e(14),fill:"#FF6B6B",fontWeight:"bold"}});return o.anchor.set(.5),i.addChild(o),i.eventMode="static",i.cursor="pointer",i.on("pointertap",()=>{if(this.onDeleteCallback){const a=new wt(B.getInstance().t("level.delete_confirm"),()=>{this.onDeleteCallback&&this.onDeleteCallback(this.levelData.id),this.removeChild(a),a.destroy()},()=>{this.removeChild(a),a.destroy()},{confirmKey:"level.delete",cancelKey:"common.cancel"});this.addChild(a)}}),i}destroy(t){window.removeEventListener("resize",this.handleResize),super.destroy(t)}}class Wt extends p{levels;onSelect;onCreate;currentPage=0;totalPages=0;laserTexture;gridContainer;headerContainer;isDragging=!1;dragStartX=0;dragStartPageX=0;dragDistance=0;scrollTweenId=0;penSelectionUI=null;settingsUI=null;userProfileCard=null;onPenSelect;currentPenId="pen_default";sortMode="latest";filterAuthorId=null;visibleLevels=[];filterAuthorName=null;filterAuthorColor=8947848;latestBtnText;popularBtnText;mineBtnText;filterFilterTagContainer;createLevelBtn;HEADER_HEIGHT_RATIO=1/5;COLS=3;ROWS=2;ITEMS_PER_PAGE=6;CARD_ASPECT_RATIO=16/9;backgroundHitArea=null;constructor(t,n,s,i,r,o){super(),this.levels=t,this.onSelect=n,this.onCreate=s,this.laserTexture=i,this.onPenSelect=r,o&&(this.currentPenId=o),this.totalPages=Math.ceil(t.length/this.ITEMS_PER_PAGE),this.headerContainer=new p,this.gridContainer=new p,this.addChild(this.gridContainer),this.addChild(this.headerContainer),this.setupHeader(),this.refreshVisibleLevels(),this.setupInteraction(),B.getInstance().subscribe(()=>{this.headerContainer.removeChildren(),this.setupHeader(),this.setupGrid()})}setupHeader(){const t=A=>B.getInstance().t(A),n=k(),s=this.getHeaderHeight(),i=new Q({fontFamily:"Arial",fontSize:e(60),fontWeight:"bold",fill:"#555555"}),r=new F({text:t("app.title"),style:i});r.position.set(e(60),(s-r.height)/2),this.headerContainer.addChild(r);const o=(s+e(10))/2;this.latestBtnText=this.createSortButton(t("sort.latest"),0,o,"latest"),this.headerContainer.addChild(this.latestBtnText),this.popularBtnText=this.createSortButton(t("sort.popular"),0,o,"popular"),this.headerContainer.addChild(this.popularBtnText),this.mineBtnText=this.createHeaderInteractiveText(t("sort.mine"),0,o,()=>{const A=P.getInstance().getUserProfile()?.id;A&&(this.filterAuthorId===A?this.setFilterAuthor(null):this.setFilterAuthor(A))}),this.headerContainer.addChild(this.mineBtnText);const a=e(40),h=this.latestBtnText.width+a+this.popularBtnText.width+a+this.mineBtnText.width,l=(n-h)/2;this.latestBtnText.x=l,this.popularBtnText.x=l+this.latestBtnText.width+a,this.mineBtnText.x=l+this.latestBtnText.width+a+this.popularBtnText.width+a,this.filterFilterTagContainer=new p,this.filterFilterTagContainer=new p,this.headerContainer.addChild(this.filterFilterTagContainer),this.updateFilterTag();const c=e(36),g=e(52),b=e(20),d=this.createHeaderButton(""),f=n-e(20)-g;d.position.set(f,c),d.on("pointertap",()=>this.showSettings()),this.headerContainer.addChild(d);const u=this.createHeaderButton(""),C=f-b-g;u.position.set(C,c),u.on("pointertap",()=>this.showPenSelection()),this.headerContainer.addChild(u),this.createLevelBtn=this.createFloatingActionButton(),this.createLevelBtn.visible=!1,this.addChild(this.createLevelBtn),this.updateSortButtons()}getHeaderHeight(){return z()*this.HEADER_HEIGHT_RATIO}createFloatingActionButton(){const t=e(64),n=new p,s=new x;s.circle(0,0,t/2),s.fill(5592405),n.addChild(s);const i=new F({text:"+",style:{fontFamily:"Arial",fontSize:e(40),fill:"#FFFFFF",fontWeight:"bold"}});return i.anchor.set(.5),i.position.set(0,0),n.addChild(i),n.position.set(k()-e(50),z()-e(50)),n.eventMode="static",n.cursor="pointer",n.on("pointertap",()=>{console.log("Create Level Attempt"),this.onCreate()}),n}createSortButton(t,n,s,i){return this.createHeaderInteractiveText(t,n,s,()=>{this.setSortMode(i)})}createHeaderInteractiveText(t,n,s,i){const r=new F({text:t,style:{fontFamily:"Arial",fontSize:e(24),fill:"#AAAAAA",fontWeight:"normal"}});return r.anchor.set(0,.5),r.position.set(n,s),r.eventMode="static",r.cursor="pointer",r.on("pointertap",i),r}updateSortButtons(){const t=P.getInstance().getUserProfile()?.id,n=this.filterAuthorId===t&&!!t;if(this.latestBtnText){const s=this.sortMode==="latest"&&!n;this.latestBtnText.style.fill=s?"#555555":"#AAAAAA",this.latestBtnText.style.fontWeight=s?"bold":"normal"}if(this.popularBtnText){const s=this.sortMode==="popular"&&!n;this.popularBtnText.style.fill=s?"#555555":"#AAAAAA",this.popularBtnText.style.fontWeight=s?"bold":"normal"}if(this.mineBtnText){const s=n;this.mineBtnText.style.fill=s?"#555555":"#AAAAAA",this.mineBtnText.style.fontWeight=s?"bold":"normal"}this.createLevelBtn&&(this.createLevelBtn.visible=!!t)}createHeaderButton(t){const n=e(52),s=new p,i=new x;i.rect(0,0,n,n),i.fill({color:16777215,alpha:.001}),s.addChild(i);const r=T.createIcon(t,e(60),"#555555");return r.style.stroke={color:"#555555",width:.5},r.position.set(n/2,n/2+e(2)),s.addChild(r),s.eventMode="static",s.cursor="pointer",s}setupGrid(){this.gridContainer.removeChildren();const t=k();for(let n=0;n<this.totalPages;n++){const s=new p;s.x=n*t,this.gridContainer.addChild(s);const i=n*this.ITEMS_PER_PAGE,r=Math.min(i+this.ITEMS_PER_PAGE,this.visibleLevels.length);this.renderPage(s,i,r)}}renderPage(t,n,s){const i=k(),r=z(),o=this.getHeaderHeight(),a=i,h=r-o,l=a*.7/this.COLS,c=Math.floor(l),g=Math.floor(c/this.CARD_ASPECT_RATIO),b=(a-c*this.COLS)/(this.COLS+1),d=(h-g*this.ROWS)/(this.ROWS+1),f=o+d;for(let u=n;u<s;u++){const C=u-n,A=Math.floor(C/this.COLS),I=C%this.COLS,w=b+I*(c+b),S=f+A*(g+d),v=this.createLevelCard(u,this.visibleLevels[u],c,g);v.position.set(w,S),t.addChild(v)}}createLevelCard(t,n,s,i){const r=new p,o=T.createShadow(s,i,0,8,.3);r.addChild(o);const a=T.createCardBackground(s,i,16777215);r.addChild(a);const h=this.createLevelThumbnail(n,s,i),l=new x;l.rect(0,0,s,i),l.fill(16777215),h.mask=l,r.addChild(l),r.addChild(h);const c=P.getInstance().getUserProfile()?.id;if(c&&n.authorId===c&&n.isPublished===!1){const w=new x;w.rect(0,0,s,i),w.fill({color:0,alpha:.2}),r.addChild(w);const S=new p,v=new x;let m="",y=0,M="#FFFFFF";n.authorPassed?(m=B.getInstance().t("status.draft"),y=8947848,M="#FFFFFF"):(m=B.getInstance().t("status.untested"),y=15658734,M="#888888");const V=e(24),H=e(12),D=e(20),L=new F({text:m,style:{fontFamily:"Arial",fontSize:e(12),fill:M,fontWeight:"bold"}}),U=Math.max(e(60),L.width+D);v.roundRect(0,0,U,V,H),v.fill(y),L.anchor.set(.5),L.position.set(U/2,V/2),S.addChild(v),S.addChild(L),S.position.set(e(10),e(10)),r.addChild(S)}else{const w=n.likes||0,S=new p,v=new F({text:w.toString(),style:{fontFamily:"Arial",fontSize:e(12),fill:"#FFFFFF",fontWeight:"bold"}}),m=e(10),y=e(14),M=e(4),V=m+y+M+v.width+m,H=e(24),D=e(12),L=new x;L.roundRect(0,0,V,H,D),L.fill({color:0,alpha:.4}),S.addChild(L);const U=T.createIcon("",y,"#FFFFFF");U.position.set(m+y/2,H/2+e(2)),S.addChild(U),v.anchor.set(0,.5),v.position.set(m+y+M,H/2),S.addChild(v),S.position.set(e(12),e(12)),r.addChild(S)}const g=e(25),b=[16739179,5164484,4569041,16760438,16742777,12246104],d=n.authorId||n.author||"unknown";let f=0;for(let w=0;w<d.length;w++)f=d.charCodeAt(w)+((f<<5)-f);const u=Math.abs(f)%b.length;let C=b[u],A;if(c&&n.authorId===c){const w=P.getInstance().getUserProfile();w&&(C=w.avatarColor,A=w.avatarUrl)}const I=T.createAvatar(g,A,C,16777215);return I.position.set(s-e(4),i-e(4)),I.eventMode="static",I.cursor="pointer",I.on("pointertap",w=>{w.stopPropagation(),this.showUserProfile(n,C)}),r.addChild(I),r.addChild(I),r.eventMode="static",r.cursor="pointer",r.on("pointertap",()=>{this.dragDistance<10&&this.onSelect(n)}),r}createLevelThumbnail(t,n,s){const i=new p,r=Math.min(n/yt,s/Bt);if(i.scale.set(r),t.obstacles&&t.obstacles.forEach(o=>i.addChild(vt.createVisual(o))),t.fallingObjects&&t.fallingObjects.forEach(o=>i.addChild(bt.createVisual(o))),t.nets&&t.nets.forEach(o=>i.addChild(It.createVisual(o))),t.iceBlocks&&t.iceBlocks.forEach(o=>i.addChild(At.createVisual(o))),t.lasers&&this.laserTexture&&t.lasers.forEach(o=>i.addChild(St.createVisual(o,this.laserTexture,14))),t.seesaws&&t.seesaws.forEach(o=>i.addChild(Ft.createVisual(o))),t.conveyors&&t.conveyors.forEach(o=>i.addChild(Tt.createVisual(o))),t.buttons&&t.buttons.forEach(o=>i.addChild(mt.createVisual(o))),t.balls){const o=dt.createVisual(t.balls.blue.x,t.balls.blue.y,"blue"),a=dt.createVisual(t.balls.pink.x,t.balls.pink.y,"pink");i.addChild(o),i.addChild(a)}return i}setupInteraction(){const t=k(),n=z(),s=this.getHeaderHeight();this.backgroundHitArea=new x,this.backgroundHitArea.rect(0,s,t,n-s),this.backgroundHitArea.fill({color:0,alpha:0}),this.addChildAt(this.backgroundHitArea,0),this.eventMode="static",this.on("pointerdown",i=>{if(this.penSelectionUI||this.userProfileCard||this.settingsUI)return;const r=this.getHeaderHeight();this.toLocal(i.global).y<r||(this.isDragging=!0,this.dragStartX=i.global.x,this.dragDistance=0,this.dragStartPageX=this.gridContainer.x)}),this.on("pointermove",i=>{if(!this.isDragging)return;const o=i.global.x-this.dragStartX;this.dragDistance=Math.max(this.dragDistance,Math.abs(o)),this.gridContainer.x=this.dragStartPageX+o}),this.on("pointerup",i=>this.endDrag(i)),this.on("pointerupoutside",i=>this.endDrag(i))}endDrag(t){if(!this.isDragging)return;this.isDragging=!1;const s=t.global.x-this.dragStartX;Math.abs(s)>50&&(s>0&&this.currentPage>0?this.currentPage--:s<0&&this.currentPage<this.totalPages-1&&this.currentPage++),this.scrollToPage(this.currentPage)}scrollToPage(t){const n=k(),s=-t*n,i=this.gridContainer.x,r=s-i,o=.3,a=Date.now(),h=++this.scrollTweenId,l=()=>{if(this.scrollTweenId!==h)return;const c=Date.now(),g=Math.min((c-a)/(o*1e3),1),b=1-Math.pow(1-g,3);this.gridContainer.x=i+r*b,g<1&&requestAnimationFrame(l)};l()}showPenSelection(){this.penSelectionUI&&(this.removeChild(this.penSelectionUI),this.penSelectionUI.destroy(),this.penSelectionUI=null),this.penSelectionUI=new xt(t=>{this.onPenSelect&&this.onPenSelect(t),this.currentPenId=t.id,this.closePenSelection()},()=>this.closePenSelection(),this.currentPenId),this.penSelectionUI.zIndex=1e3,this.addChild(this.penSelectionUI)}closePenSelection(){this.penSelectionUI&&(this.removeChild(this.penSelectionUI),this.penSelectionUI.destroy(),this.penSelectionUI=null)}showSettings(){this.settingsUI&&(this.removeChild(this.settingsUI),this.settingsUI.destroy(),this.settingsUI=null),this.settingsUI=new Pt(()=>this.closeSettings()),this.settingsUI.zIndex=2e3,this.settingsUI.on("profileUpdate",()=>{P.getInstance().getLevelList().then(t=>{this.levels=t,this.refreshVisibleLevels()})}),this.addChild(this.settingsUI)}closeSettings(){this.settingsUI&&(this.removeChild(this.settingsUI),this.settingsUI.destroy(),this.settingsUI=null,P.getInstance().getLevelList().then(t=>{this.levels=t,this.refreshVisibleLevels()}))}showUserProfile(t,n){this.userProfileCard&&(this.removeChild(this.userProfileCard),this.userProfileCard.destroy(),this.userProfileCard=null);const s=this.levels.filter(i=>i.authorId===t.authorId&&i.isPublished).length;this.userProfileCard=new Lt(t,n,(i,r)=>this.createLevelThumbnail(t,i,r),()=>this.closeUserProfile(),i=>{this.closeUserProfile(),this.setFilterAuthor(i,t.author||"",n)},()=>{P.getInstance().toggleLike(t.id),this.setupGrid()},i=>{P.getInstance().deleteLevel(i),this.closeUserProfile(),this.levels=this.levels.filter(r=>r.id!==i),this.refreshVisibleLevels()},P.getInstance().getUserProfile()?.id===t.authorId,s),this.addChild(this.userProfileCard)}closeUserProfile(){this.userProfileCard&&(this.removeChild(this.userProfileCard),this.userProfileCard.destroy(),this.userProfileCard=null)}setPen(t){this.currentPenId=t}setSortMode(t){if(this.filterAuthorId===_&&this.setFilterAuthor(null),this.sortMode===t&&this.filterAuthorId===null){this.currentPage!==0&&(this.currentPage=0,this.scrollToPage(0));return}this.sortMode=t,this.updateSortButtons(),this.refreshVisibleLevels()}setFilterAuthor(t,n,s){this.filterAuthorId!==t&&(this.filterAuthorId=t,t?(this.filterAuthorName=n||`User ${t.slice(0,4)}`,this.filterAuthorColor=s||8947848,t===_&&(this.sortMode="latest")):this.filterAuthorName=null,this.updateSortButtons(),this.updateFilterTag(),this.refreshVisibleLevels())}updateFilterTag(){if(!this.filterFilterTagContainer)return;if(this.filterFilterTagContainer.removeChildren(),!this.filterAuthorId||this.filterAuthorId===_){this.filterFilterTagContainer.visible=!1;return}this.filterFilterTagContainer.visible=!0;const t=e(40),n=e(6),s=e(12),i=e(8),r=e(28),o=e(16),a=e(14),h=16777215,l=14737632,c=3355443,g=10066329,b=16119285,d=new x,f=new x;f.circle(0,0,r/2),f.fill(this.filterAuthorColor),f.position.set(n+r/2,t/2);const u=new F({text:this.filterAuthorName||"Unknown",style:{fontFamily:"Arial",fontSize:o,fill:c,fontWeight:"bold"}});u.anchor.set(0,.5),u.position.set(n+r+i,t/2);const C=new F({text:"✕",style:{fontFamily:"Arial",fontSize:e(14),fill:g,fontWeight:"bold"}});C.anchor.set(.5);const A=n+r+i+u.width+i+a+s;d.roundRect(0,0,A,t,t/2),d.fill(h),d.stroke({width:1,color:l}),C.position.set(A-s-a/2,t/2),this.filterFilterTagContainer.addChild(d),this.filterFilterTagContainer.addChild(f),this.filterFilterTagContainer.addChild(u),this.filterFilterTagContainer.addChild(C);const I=k(),S=(z()*this.HEADER_HEIGHT_RATIO+e(10))/2;if(this.mineBtnText)this.filterFilterTagContainer.x=this.mineBtnText.x+this.mineBtnText.width+e(30);else{const v=I/2;this.filterFilterTagContainer.x=v+e(200)}this.filterFilterTagContainer.y=S-t/2,this.filterFilterTagContainer.eventMode="static",this.filterFilterTagContainer.cursor="pointer",this.filterFilterTagContainer.on("pointerover",()=>{d.clear(),d.roundRect(0,0,A,t,t/2),d.fill(b),d.stroke({width:1,color:l})}),this.filterFilterTagContainer.on("pointerout",()=>{d.clear(),d.roundRect(0,0,A,t,t/2),d.fill(h),d.stroke({width:1,color:l})}),this.filterFilterTagContainer.on("pointertap",()=>{this.setFilterAuthor(null)})}refreshVisibleLevels(){let t=this.levels;const n=this.filterAuthorId;n===_?t=t.filter(s=>s.authorId===n):n?t=t.filter(s=>(s.authorId===n||!s.authorId&&n.startsWith("mock_user"))&&s.isPublished!==!1):t=t.filter(s=>s.isPublished!==!1),t=[...t],this.sortMode==="popular"?t.sort((s,i)=>(i.likes||0)-(s.likes||0)):t.sort((s,i)=>(i.createdAt||0)-(s.createdAt||0)),this.visibleLevels=t,this.scrollTweenId++,this.currentPage=0,this.totalPages=Math.ceil(this.visibleLevels.length/this.ITEMS_PER_PAGE),this.totalPages===0&&(this.totalPages=1),this.gridContainer.x=0,this.setupGrid()}updateLayout(){this.headerContainer.removeChildren(),this.createLevelBtn&&(this.removeChild(this.createLevelBtn),this.createLevelBtn.destroy({children:!0}),this.createLevelBtn=void 0),this.backgroundHitArea&&(this.removeChild(this.backgroundHitArea),this.backgroundHitArea.destroy(),this.backgroundHitArea=null),this.setupHeader(),this.setupGrid(),this.setupInteraction(),this.currentPage>=this.totalPages&&(this.currentPage=Math.max(0,this.totalPages-1)),this.gridContainer.x=-this.currentPage*k(),this.penSelectionUI,this.userProfileCard}updateLevels(t){this.levels=t,this.refreshVisibleLevels()}}export{Wt as LevelSelectionUI};
